<!DOCTYPE html>
<html lang="en" style="position: fixed;width: 100vw;height: 100vh;left: 0;top: 0;">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport" />
  <!-- <script src="https://www.norchant.com/js/vconsole.min.js"></script> -->
  <title>红白机模拟器</title>
  <!-- <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.0.min.js"></script> -->
  <script type="text/javascript" src="./js/jquery-3.4.0.min.js"></script>
  <!-- <script type="text/javascript" src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script> -->
  <script type="text/javascript" src="./js/jsnes.min.js"></script>
  <script>
    if (window.location.href.indexOf('http:') > -1) {
      window.location.href = window.location.href.replace('http:', 'https:')
    }
  </script>
  <script>
    window.addEventListener("gamepadconnected", function (e) {
      window.gp = navigator.getGamepads()[e.gamepad.index];
      console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
        gp.index, gp.id,
        gp.buttons.length, gp.axes.length);
    });

    function processGp() {

      if (window.gp) {
        let gpKeyDic = {
          0: 'A',
          1: 'B',
          3: 'X',
          4: 'Y',
          6: 'L', // LB Left Bumper 按钮
          7: 'R', // RB Right Bumper
          8: 'ZL', // LT L2 Left Trigger 扳机
          9: 'ZR', // RT R2 Left Trigger
          10: 'Select',
          11: 'Start',
          13: 'LS', // 左摇杆按压 Left Sitck 操纵杆
          14: 'RS', // 右摇杆按压 Right Sitck

          21: '↑',
          22: '→',
          23: '↓',
          24: '←',
        }
        let gpKey2KeysDic = {
          0: 88,
          1: 89,
          3: 88,
          4: 89,
          6: 88,
          7: 88,
          8: 89,
          9: 89,
          10: 17,
          11: 13,

          21: 38,
          22: 39,
          23: 40,
          24: 37,
        }
        window.gp = navigator.getGamepads()[0];
        // 按钮部分
        window.gpBtnDownDic = window.gpBtnDownDic || {};
        let buttons = window.gp.buttons;
        for (let i = 0; i < buttons.length; i++) {
          const btn = buttons[i];
          let gpKey = i;
          if (btn.value == 1) {
            if (!window.gpBtnDownDic[i]) {
              window.gpBtnDownDic[i] = 1;
              let key = KEYS[gpKey2KeysDic[gpKey]];
              console.log(gpKey, 'is down');
              nes.buttonDown(key[0], key[1]);
            } else {
              // 按着就按着吧，不触发
            }
          } else {
            if (window.gpBtnDownDic[i]) {
              window.gpBtnDownDic[i] = 0;
              let key = KEYS[gpKey2KeysDic[gpKey]];
              console.log(gpKey, 'is up');
              nes.buttonUp(key[0], key[1]);
            } else {
              // 什么事都没有
            }
          }
        }
        // 摇杆部分
        // idx0 左摇杆 左 -1
        // idx0 左摇杆 右 1
        // idx1 右摇杆 上 -1
        // idx1 右摇杆 下 1

        // idx2 右摇杆 左 -1
        // idx2 右摇杆 右 1
        // idx5 右摇杆 上 -1
        // idx5 右摇杆 下 1
        window.gpAxesDownDic = window.gpAxesDownDic || {};
        let axes = window.gp.axes;
        for (let i = 0; i <= 1; i++) {
          const axe = axes[i];
          let gpKey;
          if (i == 0) {
            gpKey = 24;
            if (axe < -.5) {
              if (!window.gpAxesDownDic[gpKey]) {
                window.gpAxesDownDic[gpKey] = 1;
                let key = KEYS[gpKey2KeysDic[gpKey]];
                console.log(gpKey, 'is down');
                nes.buttonDown(key[0], key[1]);
              } else {
                // 按着就按着吧，不触发
              }
            } else {
              if (window.gpAxesDownDic[gpKey]) {
                window.gpAxesDownDic[gpKey] = 0;
                let key = KEYS[gpKey2KeysDic[gpKey]];
                console.log(gpKey, 'is up');
                nes.buttonUp(key[0], key[1]);
              } else {
                // 什么事都没有
              }
            }
            gpKey = 22;
            if (axe > .5) {
              if (!window.gpAxesDownDic[gpKey]) {
                window.gpAxesDownDic[gpKey] = 1;
                let key = KEYS[gpKey2KeysDic[gpKey]];
                console.log(gpKey, 'is down');
                nes.buttonDown(key[0], key[1]);
              } else {
                // 按着就按着吧，不触发
              }
            } else {
              if (window.gpAxesDownDic[gpKey]) {
                window.gpAxesDownDic[gpKey] = 0;
                let key = KEYS[gpKey2KeysDic[gpKey]];
                console.log(gpKey, 'is up');
                nes.buttonUp(key[0], key[1]);
              } else {
                // 什么事都没有
              }
            }
          }
          if (i == 1) {
            gpKey = 21;
            if (axe < -.5) {
              if (!window.gpAxesDownDic[gpKey]) {
                window.gpAxesDownDic[gpKey] = 1;
                let key = KEYS[gpKey2KeysDic[gpKey]];
                console.log(gpKey, 'is down');
                nes.buttonDown(key[0], key[1]);
              } else {
                // 按着就按着吧，不触发
              }
            } else {
              if (window.gpAxesDownDic[gpKey]) {
                window.gpAxesDownDic[gpKey] = 0;
                let key = KEYS[gpKey2KeysDic[gpKey]];
                console.log(gpKey, 'is up');
                nes.buttonUp(key[0], key[1]);
              } else {
                // 什么事都没有
              }
            }
            gpKey = 23;
            if (axe > .5) {
              if (!window.gpAxesDownDic[gpKey]) {
                window.gpAxesDownDic[gpKey] = 1;
                let key = KEYS[gpKey2KeysDic[gpKey]];
                console.log(gpKey, 'is down');
                nes.buttonDown(key[0], key[1]);
              } else {
                // 按着就按着吧，不触发
              }
            } else {
              if (window.gpAxesDownDic[gpKey]) {
                window.gpAxesDownDic[gpKey] = 0;
                let key = KEYS[gpKey2KeysDic[gpKey]];
                console.log(gpKey, 'is up');
                nes.buttonUp(key[0], key[1]);
              } else {
                // 什么事都没有
              }
            }
          }
        }
      }
    }
    window.onload = function () {
      canvasTips.addEventListener('dragover', function (e) {
        console.log(e)
        e.preventDefault(); // 必须阻止默认事件
      }, false);
      canvasTips.addEventListener('drop', function (e) {
        e.preventDefault(); // 阻止默认事件
        var files = e.dataTransfer.files; //获取文件
        // appendFile(files, '.list-drag')
        console.log(e)
        console.log(files);
        window.files = files;
        if (files[0].name.indexOf('.sav') > -1) {
          // code
          blobToDataURL(files[0], (base64) => {
            console.log(base64)
            localStorage[localStorage.romurl] = (atob(base64.replace('data:application/octet-stream;base64,', '')));
            loadSavedData()
          })
        } else {
          // code
          blobToDataURL(files[0], (base64) => {
            nes.loadROM(atob(base64.replace('data:application/octet-stream;base64,', '')));
            nes.stop();
            nes.reloadROM();
          })
        }
      }, false);

      function blobToDataURL(blob, cb) {
        let reader = new FileReader();
        reader.onload = function (evt) {
          var base64 = evt.target.result
          cb(base64)
        };
        reader.readAsDataURL(blob);
      }
    }
  </script>
  <style>
    body {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      bottom: 0;
      overflow: hidden;
      background-color: black;
      max-width: 70vh;
      width: 100%;
      height: 100%;
    }
    .btn {
      max-width: 14vh;
    }
    #btnspeed.open {
      /* opacity: 1 !important;
      right: -18vw !important; */
      filter: drop-shadow(#ff0000 2px 2px) !important;
    }
    #changePlayer {
      display: none;
    }

    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    #emulator {
      margin: 0 auto;
      width: 100%;
    }

    #canvas {
      position: fixed;
      /* width: 100%; */
      /* transform: rotate(90deg); */
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: 0 auto;
    }

    #canvasTips {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: 0 auto;
    }

    #canvasTips>span {
      display: inline-block;
      position: fixed;
      color: white;
      width: 200px;
      text-align: center;
      height: 20px;
      font-size: 20px;
      left: calc(50vw - 100px);
      top: calc(50vh - 10px);
      transform: rotateZ(90deg);
    }

    #message {
      font-family: sans-serif;
      padding: 30px;
      font-weight: 500;
    }

    #keys {
      font-size: 14px;
      font-family: sans-serif;
      padding-bottom: 15px;
    }

    #games-list {
      padding-bottom: 15px;
    }

    #game-list-box {
      display: none;
      position: absolute;
      top: calc(50vh - 25vw);
      /* right: 0; */
      right: calc(50vw - 40vw);
      bottom: 0;
      /* left: -140px; */
      width: 50vw;
      height: 50vw;
      overflow: hidden;
      opacity: .8;
      transform: rotateZ(90deg);
    }

    #game-list {
      margin-top: 0;
      height: 100%;
      overflow: auto;
      background-color: black;
    }

    #game-list-box p {
      margin: 0;
      height: 3rem;
      font-size: 1.5rem;
      line-height: 3rem;
      color: #ffffff;
      border: 1px solid #ffffff;
    }

    #fps,
    #f {
      display: none;
      opacity: .5;
    }

    #time {
      position: absolute;
      display: none;
      text-align: right;
      width: 65px;
      font-size: 13px;
      color: white;
      transform: rotateZ(90deg);
      right: calc(4vw - 27px);
      bottom: 65px;
    }

    @media screen and (min-width: 800px) {
      /* body {
        transform: rotateZ(-90deg);
        max-width: 512px;
      }
      .btn {
        display: none;
      }
      #canvas {
        width: 100% !important;
        max-width: 512px;
        margin-left: -20vh !important;
      }
      .rankArea {
        margin-left: 0px !important;
      } */
    }
  </style>
  <script>
    // 简易追踪马里奥算法
    HTMLElement.prototype.getPixelColor = function (x, y) {
      var thisContext = this.getContext("2d");
      var imageData = thisContext.getImageData(x, y, 1, 1);
      var pixel = imageData.data;
      var r = pixel[0];
      var g = pixel[1];
      var b = pixel[2];
      var a = pixel[3] / 255
      a = Math.round(a * 100) / 100;
      var rHex = r.toString(16);
      r < 16 && (rHex = "0" + rHex);
      var gHex = g.toString(16);
      g < 16 && (gHex = "0" + gHex);
      var bHex = b.toString(16);
      b < 16 && (bHex = "0" + bHex);
      var rgbaColor = "rgba(" + r + "," + g + "," + b + "," + a + ")";
      var rgbColor = "rgb(" + r + "," + g + "," + b + ")";
      var hexColor = "#" + rHex + gHex + bHex;
      return {
        rgba: rgbaColor,
        rgb: rgbColor,
        hex: hexColor,
        r: r,
        g: g,
        b: b,
        a: a
      };
    }
    // let ctx = canvas.getContext('2d');
    // window.ctx = ctx;
    // ctx.fillStyle = "red";
    // ctx.lineWidth = 4;
    let x = 0;
    let y = 0;
    let img;
    let img3;
    let tX = 0;
    let tY = 0;

    function myFunction(ev) {
      console.log('123123')
      // canvas.removeEventListener('click', myFunction);
      console.log(ev);
      // return;
      window.x = ev.offsetX;
      window.y = ev.offsetY;
      window.w = ev.target.offsetWidth;
      window.h = ev.target.offsetHeight;
      tX = x * 256 / w;
      tY = y * 240 / h;
      window.sTs = Date.now();
      console.log('src', tX, tY)
      window.tX2 = 0;
      window.tY2 = 0;
      if (!img) {
        console.log('change img')
        // img = ctx.getImageData(tX, tY, 12, 16);
        img = JSON.parse(JSON.stringify(context.getImageData(tX, tY, 12, 16)));
        console.log(context.getImageData(tX, tY, 12, 16), img);
        img.width = 12;
        img.height = 16;
      }
      window.catchDic = window.catchDic || {}
    }

    function goPikachu() {
      if (!window.w) {
        return;
      }
      let maxEC = 0;
      let isFind = false;
      for (let k = 0; k < w * h; k++) {
        if ((k % w) > 100) {
          continue;
        }
        if ((k % w) < tX - 20 || (k % w) > tX + 20) {
          continue;
        }
        if ((k / w | 0) < tY - 30 || (k / w | 0) > tY + 30) {
          continue;
        }
        let img2 = context.getImageData(k % w, k / w | 0, 12, 16);
        let eC = 0; // 颜色相同统计
        for (let j = 0; j < img.height; j++) {
          for (let i = 0; i < img.width; i++) {
            let idx = (j * img.width + i) * 4;
            let r = img.data[idx];
            let g = img.data[idx + 1];
            let b = img.data[idx + 2];
            let a = img.data[idx + 3];

            let r2 = img2.data[idx];
            let g2 = img2.data[idx + 1];
            let b2 = img2.data[idx + 2];
            let a2 = img2.data[idx + 3];

            if (img3) {
              let r3 = img3.data[idx];
              let g3 = img3.data[idx + 1];
              let b3 = img3.data[idx + 2];
              let a3 = img3.data[idx + 3];
              if (r3 == r2 && g3 == g2 && b3 == b2) {
                eC = eC + 0.05;
                // console.log(r,g,b);
                // window.catchDic[`${r},${g},${b}`]=window.catchDic[`${r},${g},${b}`] || 0;
                // window.catchDic[`${r},${g},${b}`]+=1;
              }
            }
            if (r == 0 && g == 171 && b == 0) {
              continue;
            }
            if (r == 129 && g == 121 && b == 255) {
              continue;
            }
            if (r == 117 && g == 227 && b == 0) {
              continue;
            }
            if (r == 188 && g == 25 && b == 0) {
              continue;
            }
            if (r == 177 && g == 84 && b == 0) {
              continue;
            }
            if (r == 0 && g == 0 && b == 0) {
              continue;
            }
            if (r == g && g == b) {
              continue;
            }
            if (r == r2 && g == g2 && b == b2) {
              eC++;
              // console.log(r,g,b);
              window.catchDic[`${r},${g},${b}`] = window.catchDic[`${r},${g},${b}`] || 0;
              window.catchDic[`${r},${g},${b}`] += 1;
            }
          }
        }
        eC -= Math.abs(k % w - tX);
        // eC -= 1*Math.abs(k / w|0 - tY);
        if (eC > 10 && eC > maxEC) {
          maxEC = eC;
          // console.log(eC, k, k % w, k / w | 0, img, img2)
          tX2 = k % w;
          tY2 = k / w | 0;
          // console.log('!!!!!!', k / w | 0, y, tY)
          isFind = true;
          img3 = img2;
        }
        // if (k % 2000 == 0) {
        //   console.log(Date.now() - sTs, k);
        // }
      }
      console.log(tX2, tY2, isFind)
      if (tX2 && tY2 && isFind) {
        // console.log('tar', w * h, tX2, tY2)
        clearInterval(window.shadowInter);
        window.shadowInter = setInterval(() => {
          // ctx.fillRect(tX2, tY2, 12, 16);
          context.strokeRect(tX2, tY2, 12, 16);
        })
        tX = tX2;
        tY = tY2;
      }
    }
  </script>
</head>

<body>
  <input id="fps" disabled />
  <input id="f" disabled />
  <span id="time">Ready</span>
  <canvas id="canvas" width='256px' height='240px'></canvas>
  <!-- <script>
    canvas.addEventListener('click', myFunction); // 关闭监听 画框
  </script> -->
  <div id="canvasTips"></div>
  <img id="checkImg"></img>
  <canvas id="check" width='12px' height='16px'></canvas>
  <!-- <div id="btnall"
    style="opacity:0.5;width:45vw;height:45vw;background-size: 100% auto;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:5vw;top:5vw;transform: rotate(90deg);">
  </div> -->
  <div class="btn" id="changePlayer"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size: 100% auto;background-image:url('./img/player1.png');background-repeat:no-repeat;position:fixed;right:10vw;top:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btnup">
  </div>
  <div class="btn" id="btnright"
    style="opacity:0.5;width:15vw;height:21vw;background-size: 100% auto;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:20vw;top:29vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btn12"
    style="width:15vw;height:15vw;background-size: 100% auto;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:35vw;top:35vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btndown">
  </div>
  <div class="btn" id="btn23"
    style="width:15vw;height:15vw;background-size: 100% auto;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:5vw;top:35vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btnleft"
    style="opacity:0.5;width:15vw;height:21vw;background-size: 100% auto;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:20vw;top:5vw;">
  </div>
  <div class="btn" id="btn34"
    style="width:15vw;height:15vw;background-size: 100% auto;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:5vw;top:5vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btn14"
    style="width:15vw;height:15vw;background-size: 100% auto;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:35vw;top:5vw;transform: rotate(180deg);">
  </div>
  <div class="btn top-btn" id="btnsave"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size: 100% auto;background-image:url('./img/btnsave.png');background-repeat:no-repeat;position:fixed;right:2vw;top:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn top-btn" id="btnload"
    style="display:none;opacity:0.5;width:20vw;height:8.88vw;background-size: 100% auto;background-image:url('./img/btnload.png');background-repeat:no-repeat;position:fixed;right:2vw;top:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn top-btn" id="btnspeed"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size: 100% auto;background-image:url('./img/btnspeed.png');background-repeat:no-repeat;position:fixed;right:2vw;top:35vw;transform: rotate(90deg);">
  </div>
  <div class="btn top-btn" id="btnselect"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size: 100% auto;background-image:url('./img/btnselect.png');background-repeat:no-repeat;position:fixed;right:2vw;bottom:35vw;transform: rotate(90deg);">
  </div>
  <div class="btn top-btn" id="btnstart"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size: 100% auto;background-image:url('./img/btnstart.png');background-repeat:no-repeat;position:fixed;right:2vw;bottom:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btnb"
    style="opacity:0.5;width:22vw;height:22vw;background-size: 100% auto;background-image:url('./img/btnb.png');background-repeat:no-repeat;position:fixed;left:5vw;bottom:26vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btna"
    style="opacity:0.5;width:22vw;height:22vw;background-size: 100% auto;background-image:url('./img/btna.png');background-repeat:no-repeat;position:fixed;left:5vw;bottom:5vw;transform: rotate(90deg);">
  </div>
  <div class="config-btn top-btn btn" id="config-btn"
    style="opacity: 0.5;width: 6vh;height: 6vh;background-size: 100% auto;background-image: url(./img/config.png);background-repeat: no-repeat;position: fixed;top: 47vh;right: -3vw;transform: rotate(90deg);">
  </div>
  <div class="toast-tips" id="toast-tips" style="display: none;">
    <div class="toast-confirm" id="toast-confirm">确定</div>
  </div>
  <div class="game-list-box" id="game-list-box">
    <div class="game-list" id="game-list">
      <p
        onclick="localStorage.romurl = './rom/Chip To Dale No Daisakusen 2 (J).nes';window.location.href = window.location.href;">
        松鼠大作战</p>
      <p onclick="localStorage.romurl = './rom/mario.nes';window.location.href = window.location.href;">马里奥</p>
      <p onclick="localStorage.romurl = './rom/希特勒复活.nes';window.location.href = window.location.href;">希特勒复活</p>
      <p onclick="localStorage.romurl = './rom/c31.nes';window.location.href = window.location.href;">中国象棋</p>
      <p onclick="localStorage.romurl = './rom/Double Dragon (U).nes';window.location.href = window.location.href;">
        双截龙1(美版)</p>
      <p onclick="localStorage.romurl = './rom/Yie Ar Kung-Fu (J).nes';window.location.href = window.location.href;">功夫
      </p>
      <p onclick="localStorage.romurl = './rom/iceclimb.nes';window.location.href = window.location.href;">雪人兄弟</p>
      <p
        onclick="localStorage.romurl = './rom/Dragonlance - Dragons of Flame (J).nes';window.location.href = window.location.href;">
        龙的火焰</p>
      <p onclick="localStorage.romurl = './rom/vs dr mario.nes';window.location.href = window.location.href;">马里奥医生</p>
      <p onclick="localStorage.romurl = './rom/马戏团.nes';window.location.href = window.location.href;">马戏团(中文)</p>
      <p onclick="localStorage.romurl = './rom/Makaimura (J).nes';window.location.href = window.location.href;">魔界村</p>
      <p onclick="localStorage.romurl = './rom/Battle City (J).nes';window.location.href = window.location.href;">坦克大战
      </p>
      <p onclick="localStorage.romurl = './rom/CONTRA.NES';window.location.href = window.location.href;">魂斗罗</p>
      <p onclick="localStorage.romurl = './rom/NINJAGA3.NES';window.location.href = window.location.href;">忍者龙剑传3</p>
      <p onclick="localStorage.romurl = './rom/zhonghuadaxian.nes';window.location.href = window.location.href;">中华大仙
      </p>
      <p
        onclick="localStorage.romurl = './rom/Chuugoku Senseijutsu (Japan).nes';window.location.href = window.location.href;">
        中国占星术</p>
      <p onclick="localStorage.romurl = './rom/BOMBMAN.NES';window.location.href = window.location.href;">炸弹人</p>
      <p onclick="localStorage.romurl = './rom/Bomberman 2 (U).nes';window.location.href = window.location.href;">炸弹人2
      </p>
      <p onclick="localStorage.romurl = './rom/smbc.nes';window.location.href = window.location.href;">马里奥双人版</p>
      <p onclick="localStorage.romurl = './rom/X-MEN.NES';window.location.href = window.location.href;">X-MEN</p>
      <p onclick="localStorage.romurl = './rom/kdxfzwb.nes';window.location.href = window.location.href;">快打旋风中文</p>
      <p onclick="localStorage.romurl = './rom/ZELDA.NES';window.location.href = window.location.href;">ZELDA</p>
      <p onclick="localStorage.romurl = './rom/ZELDA2.NES';window.location.href = window.location.href;">ZELDA2</p>
      <p onclick="localStorage.romurl = './rom/Zelda Outlands.nes';window.location.href = window.location.href;">
        塞尔达1</p>
      <p onclick="localStorage.romurl = './rom/KIRBYADV.NES';window.location.href = window.location.href;">卡比历险记</p>
      <p
        onclick="localStorage.romurl = './rom/Hoshi No Kirby - Yume No Izumi No Monogatari (J).nes';window.location.href = window.location.href;">
        卡比历险记-日</p>
      <p
        onclick="localStorage.romurl = './rom/Meitantei Holmes - Kiri No London Satsujin Jiken (J).nes';window.location.href = window.location.href;">
        侦探-日</p>
      <p onclick="localStorage.romurl = './rom/Startropics.NES';window.location.href = window.location.href;">
        Startropics</p>
      <p
        onclick="localStorage.romurl = './rom/Adventures of Lolo (J).nes';window.location.href = window.location.href;">
        Lolo</p>
      <p onclick="localStorage.romurl = './rom/LOLO2.NES';window.location.href = window.location.href;">Lolo2</p>
      <p onclick="localStorage.romurl = './rom/LOLO3.NES';window.location.href = window.location.href;">Lolo3</p>
      <p onclick="localStorage.romurl = './rom/Moon Ranger (U).nes';window.location.href = window.location.href;">Moon
        Ranger</p>
      <p onclick="localStorage.romurl = './rom/rexuequgunqiu.nes';window.location.href = window.location.href;">热血曲棍球
      </p>
      <p onclick="localStorage.romurl = './rom/热血物语中文版.nes';window.location.href = window.location.href;">热血物语</p>
      <p
        onclick="localStorage.romurl = './rom/re_xue_gao_xiao_duo_bi_qiu.nes';window.location.href = window.location.href;">
        热血高校</p>
      <p onclick="localStorage.romurl = './rom/rxgd.nes';window.location.href = window.location.href;">热血格斗</p>
      <p
        onclick="localStorage.romurl = './rom/Kunio_Kun_no_Nekketsu_Soccer_League_(J)(T+C)(AirTeam)build_070217.nes';window.location.href = window.location.href;">
        热血足球3</p>
      <!-- <p onclick="localStorage.romurl = './rom/rxsdj.nes';window.location.href = window.location.href;">热血时代剧</p> -->

      <p onclick="localStorage.romurl = './rom/三国志英杰传(吞食天地1).NES';window.location.href = window.location.href;">吞食天地1
      </p>
      <p onclick="localStorage.romurl = './rom/吞食天地2 (不花屏版) [先锋卡通汉化].nes';window.location.href = window.location.href;">
        吞食天地2</p>
      <p onclick="localStorage.romurl = './rom/呑食天地Ⅰ曹魏英豪传（吞2音乐）.nes';window.location.href = window.location.href;">吞1曹魏
      </p>
      <p onclick="localStorage.romurl = './rom/冒险岛1.nes';window.location.href = window.location.href;">冒险岛1</p>
      <p onclick="localStorage.romurl = './rom/冒险岛2.nes';window.location.href = window.location.href;">冒险岛2</p>
      <p onclick="localStorage.romurl = './rom/冒险岛3.nes';window.location.href = window.location.href;">冒险岛3</p>
      <p onclick="localStorage.romurl = './rom/冒险岛4.nes';window.location.href = window.location.href;">冒险岛4</p>

      <p onclick="localStorage.romurl = './rom/冒险岛1(无敌).nes';window.location.href = window.location.href;">冒险1无敌</p>
      <p onclick="localStorage.romurl = './rom/冒险岛2无限.nes';window.location.href = window.location.href;">冒险2无限</p>
      <p onclick="localStorage.romurl = './rom/冒险岛3(无限人、血).nes';window.location.href = window.location.href;">冒险3无限</p>
      <p onclick="localStorage.romurl = './rom/冒险岛4(无敌).nes';window.location.href = window.location.href;">冒险4无敌</p>


      <!-- <p onclick="localStorage.romurl = './rom/爆笑三国(上古神剑).nes';window.location.href = window.location.href;">爆笑三国</p> -->
      <!-- <p onclick="localStorage.romurl = './rom/三国志Ⅱ--霸王的大陆_外星汉化版.nes';window.location.href = window.location.href;">三国志Ⅱ</p> -->
      <!-- <p onclick="localStorage.romurl = './rom/三国志超级版.nes';window.location.href = window.location.href;">三国志超级版</p> -->
      <!-- <p onclick="localStorage.romurl = './rom/重装机兵plus6.0大车版.nes';window.location.href = window.location.href;">重装机兵大车版</p> -->
      <!-- <p onclick="localStorage.romurl = './rom/第2次超级机器人大战.NES';window.location.href = window.location.href;">机器人大战2</p> -->
      <!-- <p onclick="localStorage.romurl = './rom/第4次机器人大战.NES';window.location.href = window.location.href;">机器人大战4</p> -->
      <!-- 74 -->
      <p onclick="localStorage.romurl = './rom/影子传说.nes';window.location.href = window.location.href;">影子传说</p>
      <p onclick="localStorage.romurl = './rom/影子传说 [中伟汉化 MS修正].nes';window.location.href = window.location.href;">
        影子传说(中)</p>

      <p onclick="localStorage.romurl = './rom/Duck Tales  (E).nes';window.location.href = window.location.href;">唐老鸭大陆1
      </p>
      <p onclick="localStorage.romurl = './rom/Duck Tales 2  (U).nes';window.location.href = window.location.href;">
        唐老鸭大陆2</p>
      <!-- <p onclick="localStorage.romurl = './rom/100IN1.NES';window.location.href = window.location.href;">100IN1</p> -->


      <p onclick="window.location.href = '/gba'">gba</p>

      <!-- This ROM uses a mapper not supported by JSNES: Namcot 106 chip(19) -->
      <!-- <p onclick="localStorage.romurl = './rom/Sangokushi 2.nes';window.location.href = window.location.href;">三国志2霸王的大陆</p> -->

    </div>
  </div>
  <style>
    .aTransBox {
      position: absolute;
      bottom: 5vw;
      /* right: calc(50vw - 10vw); */
      right: calc(50vw - 20vw);
      width: 20vw;
      height: 20vw;
      background: white;
      transform: rotate(90deg);
      box-sizing: border-box;
      font-size: 0;
      /* white-space: nowrap; */
      /* overflow: hidden; */
      background-color: rgba(0,0,0,0);
      opacity: .6;
    }
    .aTransBox>a {
      margin: 0;
      margin-left: 0;
      width: 100%;
      height: 100%;
    }
    .aTransBox>a:first-child {
      /* animation: adAround 20s infinite; */
      /* margin-left: -200px; */
    }
    .aTransBox>a {
      display: inline-block;
    }
    .aTransBox img{
      width: 100%;
      height: 100%;
    }
    @keyframes adAround
    {
    0% {margin-left: 0;}
    10% {margin-left: 0;}
    20% {margin-left: -100%;}
    30% {margin-left: -100%;}
    40% {margin-left: -200%;}
    50% {margin-left: -200%;}
    60% {margin-left: -100%;}
    70% {margin-left: -100%;}
    80% {margin-left: -0%;}
    }
  </style>
  <div class="aTransBox">
    <!-- <a href="http://h5.akwan.cn/games/play/16?rel=6920_579">
      <img src="http://cdn.akwan.cn/storage/images/tPqRMisKGU1hZaftDUywnj4lMZX6BQijfseR8OT0.gif">
    </a>
    <a href="http://h5.akwan.cn/games/play/4?rel=6920_576">
      <img src="http://cdn.akwan.cn/storage/images/R1UNBbGmJ6UcqP1gIA5cN0c8IpLkGSmnnKdyPDUO.png">
    </a>
    <a href="http://h5.akwan.cn/games/play/9?rel=6920_577">
      <img src="http://cdn.akwan.cn/storage/images/AhaEyY2Pdkdx9nTKjT3pFPbEPNlViHsaeWkrMZdI.png">
    </a> -->
    <a onClick="toad('wxfe397c095eba31ed', 'pages/index/index?ad_code=2620', '点击此按钮进入九州仙侠传', 6)">
      <img src="http://cdn.akwan.cn/storage/images/tPqRMisKGU1hZaftDUywnj4lMZX6BQijfseR8OT0.gif">
    </a>
    <a onClick="toad('wx9b8b8f915730c746', 'pages/index/index?ad_code=2619', '点击此按钮进入封神策', 6)">
      <img src="http://cdn.akwan.cn/storage/images/0Y3szFxC3WDASXyaOJTYwlIrut8wRWgV6Yy0mPuB.png">
    </a>
  </div>
  <script>
    function toad(appId, path, tips, leftTime) {
      console.log('toad');
      socket.emit('m', {msg:window.tid+'tomin',appId: appId, path: path, tips: tips, leftTime: leftTime|| 9});
    }
  </script>
  <!-- 排名部分代码 -->
  <style>
    .rankArea {
      display: none;
      font-size: 0;
      background-color: #111111;
      position: fixed;
      width: 200px;
      height: 80vw;
      max-height: 336px;
      top: 0;
      right: 0;
      bottom: 160px;
      left: 0;
      margin: auto;
      text-align: center;
      padding-top: 10px;
      transform: rotateZ(90deg);
      border-radius: 3px;
      box-shadow: 0px 0px 20px #11111188;
    }

    .rankCloseBtn {
      position: absolute;
      width: 31px;
      height: 31px;
      bottom: 15px;
      left: -100px;
      right: 0;
      margin: auto;
      font-size: 30px;
    }

    .rankChallengeBtn {
      position: absolute;
      width: 30px;
      height: 30px;
      bottom: 15px;
      left: 0;
      right: -100px;
      margin: auto;
      font-size: 30px;
    }

    .coin {
      position: absolute;
      width: 30px;
      height: 30px;
      bottom: 15px;
      left: 0px;
      right: -160px;
      margin: auto;
      font-size: 30px;
      vertical-align: middle;
      color: #f7b400;
      line-height: 30px;
    }

    .rankCloseBtn:active,
    .rankChallengeBtn:active {
      opacity: .6;
    }

    .rankBox {
      height: calc(100% - 30px - 60px);
      overflow: auto;
    }

    .rankTitle {
      font-size: 20px;
      color: #fffeff;
      margin-bottom: 5px;
    }

    .rankP {
      padding-left: 2px;
      background-color: #b15400;
      display: inline-block;
      width: 90%;
      height: 25px;
      box-sizing: border-box;
      border: 1px solid #e6a886;
      margin: 1px 0;
      text-align: left;
    }

    .rankP.me {
      border: 1px solid #3dabff;
    }

    .rankP:active {
      opacity: .6;
    }

    .rankIdx,
    .rankName,
    .rankUsetime {
      display: inline-block;
      overflow: hidden;
      color: #ffd1c7;
      line-height: 20px;
    }

    .rankIdx {
      width: 30px;
      color: #f7b400;
      font-size: 20px;
    }

    .rankName {
      width: 85px;
      font-size: 16px;
    }

    .rankUsetime {
      width: 55px;
      font-size: 16px;
    }
  </style>
  <style>
    .tipsArea {
      display: none;
      background-color: #111111;
      position: fixed;
      width: 160px;
      height: 80vw;
      max-height: 336px;
      top: 200px;
      right: 0;
      bottom: 0px;
      left: 0;
      margin: auto;
      text-align: left;
      padding-top: 10px;
      transform: rotateZ(90deg);
      border-radius: 3px;
      font-size: 12px;
      box-shadow: 0px 0px 20px #11111188;
      color: #3dabff;
      text-indent: 2em;
      font-weight: 200;
    }

    .tipsArea>p {
      padding: 4px 9px;
      margin: 2px 0;
    }

    .rankChallengeIcon {
      width: 12px;
      height: 12px;
    }

    .tipsArea .tipsPs {
      position: absolute;
      bottom: 10px;
      text-indent: 0;
      font-size: 8px;
    }

    .goldText {
      color: #f7b400;
      font-weight: 600;
    }

    .tipsArea input {
      color: #f7b400;
      border: none;
      margin: 0;
      padding: 0;
      border: 1px solid transparent;
      outline: none;
      -webkit-appearance: none;
      background-color: rgba(0, 0, 0, 0);
      text-align: center;
      width: 100%;
    }

    .toast-tips {
      position: fixed;
      top: 40vh;
      right: -3vw;
      padding: 8px;
      width: 30vh;
      height: 18vh;
      transform: rotate(90deg);
      background-color: black;
      font-size: 16px;
      color: white;
      font-weight: 400;
      text-align: center;
      border: 2px solid white;
      border-radius: 16px;
      opacity: .8;
      z-index: 999;
    }

    .toast-confirm {
      bottom: 0;
      width: 100%;
      position: absolute;
      height: 25px;
      left: 0;
      border-top: 2px solid;
      cursor: pointer;
      z-index: 999;
    }

    .toast-confirm:active {
      opacity: .6;
    }
  </style>
  <div id="rankArea" class="rankArea">
    <div id="rankTitle" class="rankTitle">TEKII 09.05 RANK</div>
    <div id="rankBox" class="rankBox">
      <div class="rankP">
        <span class="rankIdx">01</span>
        <span class="rankName">Maxmon</span>
        <span class="rankUsetime">24.95</span>
      </div>
      <div class="rankP">
        <span class="rankIdx">02</span>
        <span class="rankName">Yahaha</span>
        <span class="rankUsetime">27.95</span>
      </div>
    </div>
    <!-- <svg t="1599302195443" onclick="hideRank()" class="rankCloseBtn" viewBox="0 0 1024 1024" version="1.1"
      xmlns="http://www.w3.org/2000/svg" p-id="1383" width="90" height="90">
      <path
        d="M511.968 376.224 796.096 92.096C833.536 54.624 894.4 54.624 931.84 92.096 969.312 129.568 969.312 190.4 931.84 227.872L647.744 512 931.84 796.096C969.312 833.568 969.312 894.4 931.84 931.872 894.4 969.344 833.536 969.344 796.096 931.872L511.968 647.744 227.84 931.872C190.4 969.344 129.536 969.344 92.096 931.872 54.624 894.4 54.624 833.568 92.096 796.096L376.224 512 92.096 227.872C54.624 190.4 54.624 129.568 92.096 92.096 129.536 54.624 190.4 54.624 227.84 92.096L511.968 376.224Z"
        p-id="1384" fill="#ffffff"></path>
    </svg> -->
    <svg t="1599320359254" onclick="hideRank()" class="rankCloseBtn" viewBox="0 0 1024 1024" version="1.1"
      xmlns="http://www.w3.org/2000/svg" p-id="2480" width="90" height="90">
      <path
        d="M512.001 15.678C237.414 15.678 14.82 238.273 14.82 512.86S237.414 1010.04 512 1010.04s497.18-222.593 497.18-497.18S786.589 15.678 512.002 15.678z m213.211 645.937c17.798 17.803 17.798 46.657 0 64.456-17.798 17.797-46.658 17.797-64.456 0L512.001 577.315 363.241 726.07c-17.799 17.797-46.652 17.797-64.45 0-17.804-17.799-17.804-46.653 0-64.456L447.545 512.86 298.79 364.104c-17.803-17.798-17.803-46.657 0-64.455 17.799-17.798 46.652-17.798 64.45 0l148.761 148.755 148.755-148.755c17.798-17.798 46.658-17.798 64.456 0 17.798 17.798 17.798 46.657 0 64.455L576.456 512.86l148.756 148.755z m0 0"
        fill="#bc1900" p-id="2481"></path>
    </svg>
    <svg t="1599318965085" onclick="startChallenge()" class="rankChallengeBtn" viewBox="0 0 1024 1024" version="1.1"
      xmlns="http://www.w3.org/2000/svg" p-id="16010" width="90" height="90">
      <path
        d="M512 1024C229.239467 1024 0 794.760533 0 512S229.239467 0 512 0 1024 229.239467 1024 512 794.760533 1024 512 1024z m326.200889-467.626667c-20.707556-178.084978-57.344-305.743644-173.6704-305.743644-58.936889 0-89.201778 59.892622-141.789867 64.625778-54.158222-4.733156-82.852978-64.625778-141.812622-64.625778-116.303644 0-152.940089 127.658667-172.077511 304.173511-11.150222 94.549333-1.592889 173.351822 57.366755 173.351822 82.830222 0 86.038756-74.069333 144.9984-108.7488 22.300444-11.036444 71.68-15.746844 113.095112-17.339733 41.437867 1.592889 90.840178 6.303289 113.140622 17.339733 58.936889 34.679467 62.122667 108.7488 144.9984 108.7488 57.344 1.592889 65.308444-77.232356 55.751111-171.781689z"
        p-id="16011" fill="#f7b400"></path>
      <path
        d="M382.520889 540.626489c-46.193778 0-82.830222-37.842489-82.830222-81.965511 0-44.123022 36.636444-81.942756 82.830222-81.942756 46.193778 0 82.852978 36.2496 82.852978 81.942756 0 45.715911-38.229333 81.965511-82.830223 81.965511z m-47.786667-81.965511c0 12.606578 4.778667 23.643022 14.336 33.109333 7.964444 7.873422 20.707556 14.176711 33.450667 14.176711 12.743111 0 23.893333-4.733156 33.450667-14.176711 7.964444-7.896178 14.336-20.48 14.336-33.109333 0-12.606578-4.778667-23.643022-14.336-33.086578-7.964444-7.873422-20.707556-14.199467-33.450667-14.199467-12.743111 0-23.893333 4.733156-33.450667 14.199467-9.557333 7.873422-14.336 20.48-14.336 33.086578zM753.755022 474.430578h-65.308444v64.625778h-31.857778v-64.625778h-65.353956v-31.516445h65.3312v-63.032889h31.857778v63.032889h65.3312z"
        p-id="16012" fill="#f7b400"></path>
    </svg>
    <span id="coin" class="coin"></span>
  </div>
  <div id="tipsArea" class="tipsArea">
    <p>第一关通关耗时小于30秒，会获得一个<span class="goldText">3~10元</span>的支付宝口令红包，加油哦ヾ(≧▽≦*)o</p>
    <p>第一关通关耗时小于18.5秒，会获得一个<span class="goldText">50元</span>的微信红包，给大神倒茶~(　o=^•ェ•)o　┏━┓</p>
    <p>点击<svg t="1599318965085" onclick="startChallenge()" class="rankChallengeIcon" viewBox="0 0 1024 1024"
        version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="16010" width="90" height="90">
        <path
          d="M512 1024C229.239467 1024 0 794.760533 0 512S229.239467 0 512 0 1024 229.239467 1024 512 794.760533 1024 512 1024z m326.200889-467.626667c-20.707556-178.084978-57.344-305.743644-173.6704-305.743644-58.936889 0-89.201778 59.892622-141.789867 64.625778-54.158222-4.733156-82.852978-64.625778-141.812622-64.625778-116.303644 0-152.940089 127.658667-172.077511 304.173511-11.150222 94.549333-1.592889 173.351822 57.366755 173.351822 82.830222 0 86.038756-74.069333 144.9984-108.7488 22.300444-11.036444 71.68-15.746844 113.095112-17.339733 41.437867 1.592889 90.840178 6.303289 113.140622 17.339733 58.936889 34.679467 62.122667 108.7488 144.9984 108.7488 57.344 1.592889 65.308444-77.232356 55.751111-171.781689z"
          p-id="16011" fill="#f7b400"></path>
        <path
          d="M382.520889 540.626489c-46.193778 0-82.830222-37.842489-82.830222-81.965511 0-44.123022 36.636444-81.942756 82.830222-81.942756 46.193778 0 82.852978 36.2496 82.852978 81.942756 0 45.715911-38.229333 81.965511-82.830223 81.965511z m-47.786667-81.965511c0 12.606578 4.778667 23.643022 14.336 33.109333 7.964444 7.873422 20.707556 14.176711 33.450667 14.176711 12.743111 0 23.893333-4.733156 33.450667-14.176711 7.964444-7.896178 14.336-20.48 14.336-33.109333 0-12.606578-4.778667-23.643022-14.336-33.086578-7.964444-7.873422-20.707556-14.199467-33.450667-14.199467-12.743111 0-23.893333 4.733156-33.450667 14.199467-9.557333 7.873422-14.336 20.48-14.336 33.086578zM753.755022 474.430578h-65.308444v64.625778h-31.857778v-64.625778h-65.353956v-31.516445h65.3312v-63.032889h31.857778v63.032889h65.3312z"
          p-id="16012" fill="#f7b400"></path>
      </svg>进入挑战~</p>
    <input type="button" id="isShowRedPack" />
    <p class="tipsPs">(首次登陆赠送3次挑战机会，之后每天1次，看广告可以增加1次多，新玩家进入在线用户均可加1金币，金币上限3枚，广告收入会累加到奖金中~)</p>
  </div>
  <textarea id="copyTextDom" style="zIndex:-1;position: fixed;top: -100px;width: 1px;height: 1px;"></textarea>
  <script>
    function generateUserkey() {
      let charStr = '23456789ABCDEFGHIJKLMNPQSTUVWXYZ';
      let userkey = '';
      for (let i = 0; i < 4; i++) {
        userkey += charStr[charStr.length * Math.random() | 0];
      }
      return userkey;
    }
    localStorage.userkey = localStorage.userkey || generateUserkey();
    window.userkey = localStorage.userkey;
    $.ajax({
      url: '/market/fc/login?userkey=' + window.userkey,
      complete: function (xhr, status) {
        let result = xhr.responseJSON
        if (result.info) {
          localStorage.userid = result.info.id;
          window.name = result.info.name;
          window.tid = result.info.tid;
        }
      }
    });
    let month = ('00' + (new Date().getMonth() + 1)).substr(-2);
    let date = ('00' + new Date().getDate()).substr(-2);
    document.getElementById('rankTitle').innerText = `TEKII ${month}.${date} RANK`;

    function copy(tarText) {
      var copyTextDom = document.getElementById("copyTextDom");
      copyTextDom.innerText = tarText;
      copyTextDom.select(); // 选择对象
      document.execCommand("Copy"); // 执行浏览器复制命令
    }
    if (localStorage.isShowRedPack) {
      document.getElementById('isShowRedPack').value = localStorage.isShowRedPack
      document.getElementById('isShowRedPack').onclick = function () {
        copy(localStorage.isShowRedPack);
        toast('支付宝红包口令已复制到剪贴板。如已被领完，可联系微信maqijun123456补发', {t:3000})
      }
    }
  </script>
  <script>
    setTimeout(()=>{
      toast('小霸王玩累了的话，可以体验一下右边的游戏，还不错的(●\'◡\'●)', {t: 3000})
    }, 100000)
    setTimeout(()=>{
      toast('游戏可以存档哦，点击左上角存档按钮存档(●\'◡\'●)\n喜欢仙侠游戏的话，可以玩玩右边的游戏~', {t: 4000})
    }, 300000)
    setTimeout(()=>{
      toast('注意休息哦(●\'◡\'●)\n保护眼睛很重要', {t: 3000})
    }, 600000)
    function toast(msg, config = {}) {
      let toastTips = document.getElementById('toast-tips');
      window.toastTips = toastTips;
      if (config.do) config.do();
      toastTips.innerHTML = `${msg}<div class="toast-confirm" id="toast-confirm">确定</div>`;
      let toastConfirmBtn = document.getElementById('toast-confirm');
      clearTimeout(window.toastTimer);
      window.toastCb = config.cb;
      if (config.isShowConfirmBtn) {
        toastConfirmBtn.style.display = 'inline-block';
        toastConfirmBtn.onclick = toastConfirm
      } else {
        toastConfirmBtn.style.display = 'none';
      }
      toastTips.style.display = 'inline-block';
      window.toastTimer = setTimeout(() => {
        toastTips.style.display = 'none';
        if (config.cb) {
          window.toastCb()
        }
      }, config.t || 1500)
    }
    function toastConfirm() {
      clearTimeout(window.toastTimer);
      window.toastTips.style.display = 'none';
      window.toastCb && window.toastCb();
    }
    var coins = localStorage.coins ? Number(localStorage.coins) : 3;
    let coinDate = new Date().getDate();
    localStorage.coinDate = localStorage.coinDate || coinDate;
    if (localStorage.coinDate != coinDate) {
      addCoin();
      localStorage.coinDate = coinDate;
    }

    function hideRank() {
      $.ajax({
        url: '/market/fc/log?type=hideRank&remark=' + localStorage.userid
      });
      document.getElementById('rankArea').style.display = 'none';
      document.getElementById('tipsArea').style.display = 'none';
    }

    function startChallenge() {
      $.ajax({
        url: '/market/fc/log?type=startChallenge&remark=' + localStorage.userid
      });
      if (!localStorage.userid) {
        toast('查询用户id出了些问题，请联系开发者小马的微信18868196263');
      } else {
        if (coins <= 0) {
          addCoin();
          // socket.emit('m', {msg:window.tid+'showad'});
          if (Math.random() > .5) {
            socket.emit('m', {msg:window.tid+'tomin',appId:"wxfe397c095eba31ed", path:"pages/index/index?ad_code=2620", tips:"玩九州仙侠传60秒来获取币", leftTime: 5});
          } else {
            socket.emit('m', {msg:window.tid+'tomin',appId:"wx9b8b8f915730c746", path:"pages/index/index?ad_code=2619", tips:"玩封神策60秒来获取游戏币", leftTime: 5});
          }
        } else {
          subCoin()
          localStorage.coins = coins;
          hideRank();
          window.isChallenge = true;
          setTimeout(() => {
            nes.buttonDown(1, jsnes.Controller.BUTTON_START);
            setTimeout(() => {
              nes.buttonUp(1, jsnes.Controller.BUTTON_START);
            }, 200)
          }, 200)
          setTimeout(() => {
            nes.buttonDown(1, jsnes.Controller.BUTTON_START);
            setTimeout(() => {
              nes.buttonUp(1, jsnes.Controller.BUTTON_START);
            }, 200)
          }, 1500)
          if (speakers.audioCtx)
            speakers.audioCtx.resume();
          // setTimeout(()=>{
          //   if (speakers.audioCtx)
          //     speakers.audioCtx.resume();
          // }, 5000)
        }
      }
    }

    function addCoin() {
      $.ajax({
        url: '/market/fc/log?type=addCoin&remark=' + localStorage.userid
      });
      coins++;
      if (coins > 5) {
        coins = 3;
      }
      slashCoin()
    }

    function subCoin() {
      $.ajax({
        url: '/market/fc/log?type=subCoin&remark=' + localStorage.userid
      });
      coins--;
      slashCoin()
    }

    function slashCoin() {
      localStorage.coins = coins;
      document.getElementById('coin').innerText = coins;
    }
    slashCoin()

    function getRank() {
      $.ajax({
        url: '/market/fc/getWin',
        complete: function (xhr, status) {
          let winList = xhr.responseJSON.info || [];
          window.winList = winList;
          let rankBox = document.getElementById('rankBox');
          console.log(winList)
          rankBox.innerHTML = '';
          for (let i = 0; i < winList.length; i++) {
            let rankP = document.createElement('div');
            rankP.className = 'rankP';
            console.log(localStorage.userid, winList[i].userid)
            if (localStorage.userid == winList[i].userid) {
              rankP.className = 'rankP me'
            }
            rankP.onclick = function () {
              showZZDJS(i);
            }
            rankP.innerHTML = `<span class="rankIdx">${('00' + (i + 1)).substr(-2)}</span>
              <span class="rankName">${winList[i].name}</span>
              <span class="rankUsetime">${Number(Number(winList[i].usetime / 1000).toFixed(2))}</span>`
            rankBox.appendChild(rankP);
          }
          // 隐藏活动先
          // document.getElementById('rankArea').style.display = 'block';
          // document.getElementById('tipsArea').style.display = 'block';
        }
      });
    }
    if (localStorage.isNoNeedLoadTeach != '1') {
      setTimeout(()=>{
        toast('点击右上角的开始，可以开始游戏')
      }, 2000)
      setTimeout(()=>{
        toast('点击屏幕上方的方块，切换游戏')
      }, 5000)
    }

    function restartGame() {
      window.nes.reloadROM();
      window.frame = 0;
      window.clearInterval(window.nesInterval);
      window.nesInterval = setInterval(function () {
        goF(nes);
        if (frameSpeed == 5) {
          goF(nes);
          goF(nes);
        }
      }, 16);
    }

    function showZZDJS(id) {
      window.arr = JSON.parse(window.winList[id].step);
      window.isZZDJS = true;
      window.isChallenge = true;
      restartGame();
      hideRank();
    }
  </script>
  <style>
    .top-btn:active {
      opacity: 0.2 !important;
    }

    .btn.active {
      opacity: 0.2 !important;
    }

    #btnup {
      opacity: 0.5;
      width: 15vw;
      height: 20vw;
      background-size: 100% auto;
      background-image: url(./img/btn.png);
      background-repeat: no-repeat;
      position: fixed;
      left: 37.5vw;
      top: 17.5vw;
      transform: rotate(90deg);
      background-position: bottom;
    }

    #btndown {
      opacity: 0.5;
      width: 15vw;
      height: 20vw;
      background-size: 100% auto;
      background-image: url(./img/btn.png);
      background-repeat: no-repeat;
      position: fixed;
      left: 2.5vw;
      top: 17.5vw;
      transform: rotate(270deg);
      background-position: bottom;
    }
  </style>
  <script>
    window.playerId = window.location.href.indexOf('p2') > -1 ? 2 : 1;
    let f = document.getElementById('f')
    window.cId = Math.random().toString().substr(2, 5);
    let startFrame = 0;

    function goF(nes) {
      if (window.pause) {
        return;
      }
      nes.f = nes.f || 0
      if (window.maxF && nes.f > window.maxF - 2) {
        return;
      }
      nes.f++;
      f.value = nes.f;
      processGp();
      nes.frame();
      // if (frame % 600 == 0) {
      //   // 每个10秒自动保存
      //   saveData({ isAuto: true })
      // }
    }

    function loadStepSave(stepSave) {
      window.arr = stepSave;
      let sTs = Date.now();
      for (const i in stepSave) {
        while (nes.f < i) {
          goF(nes);
        }
      }
      let eTs = Date.now();
      console.log(eTs - sTs, window.frame, window.frame * 1000 / (eTs - sTs));
    }
    window.loadStepSave = loadStepSave;
    /**
     * TODO::
     *   音频无法播放 The AudioContext was not allowed to start（手机端加载存档后 直接也没声音）
     *   更流畅的双屏联机功能
     *   代码简化
     *   游戏选择功能
     *   重启游戏功能
     *   回放功能
     *   后台存储存档/存储nes文件
     */
    // 是否记录操作，不是 就自动按按钮
    // var romurl = "https://bmob-cdn-22939.bmobcloud.com/2019/06/23/7184934a405e956a804a676bc29c15ba.nes";
    if (localStorage.romurl == 'undefined') {
      localStorage.clear()
    }
    var romurl = localStorage.romurl ? localStorage.romurl :
      "./rom/mario.nes"; //"./rom/Chip To Dale No Daisakusen 2 (J).nes"; 
    localStorage.romurl = romurl;
    if (localStorage.romurl == './rom/mario.nes') {
      getRank()
    }
    // 是否是存入档案阶段，不是 就自动读档
    let isNesIn = false;
    window.nes = null;
    var nes2 = null;
    // if (!isNesIn) {
    //   localStorage.nes ? (nes2 = JSON.parse(localStorage.nes)) : '';
    // }
    // 加载速度
    let frameSpeed = 1;
    let isConfigShow = false;
    var interval;
    let rDic = {}

    function setB2A(a, b, _k = []) {
      for (const key in b) {
        if (b.hasOwnProperty(key)) {
          const bV = b[key];
          if (bV instanceof Object) {
            if (a[key]) {
              // 透明度好了 step1 加上了这个好了
              // if (key == 'opaque') {
              //   return;
              //   console.log('keykeykeyk', opaque)
              // }
              setB2A(a[key], b[key], [..._k, key]);
            } else {
              // a[key] = {};
              // 这个地方很神奇，如果转换了 就报错了Cannot read property 'opaque' of undefined，但能显示主角，不显示背景
              // 如果把这里注释掉，就能显示背景，但主角和怪物什么的 都会变成马赛克
              a[key] = {}; // 透明度好了 step2 加上了这个好了
              setB2A(a[key], b[key], [..._k, key]);
              // console.log('key', key, bV)
            }
          } else {
            if (a[key] !== b[key] && _k && !rDic[_k]) {
              console.log(', _k', _k)
              rDic[_k.toString()] = 1
            }
            // if (_k[1] == 'mem' || _k[0] == 'mmap'
            //     // || _k[1] == 'vramMem' || _k[1] == 'spriteMem' || _k[1] == 'imgPalette' || _k[1] == 'buffer' || _k[1] == 'pixrendered' || _k[1] == 'bgbuffer'
            //     || _k[1] == 'nameTable'
            //     ) {
            //   a[key] = b[key];
            // }
            a[key] = b[key];
          }
        }
      }
    }

    function loadCpuMem(nes, mem) {
      nes.cpu.mem = mem;
    }

    function loadPpuNameTable(nes, nameTable) {
      setB2A(nes.ppu.nameTable, nameTable)
    }

    function loadMmap(nes, mmap) {
      setB2A(nes.mmap, mmap)
    }

    function loadSavedData(config = {}) {
      console.log('load dataaaaaaaaaaaaa in')
      $('#game-list-box').hide();
      key = localStorage.romurl;
      if (config.isAuto) {
        key = 'autoSave'
      }
      if (localStorage[key]) {
        console.log('inininin')
        console.log('load dataaaaaaaaaaaaa innnnnnnnnnnnnnnn')

        // $.get('https://tekii.cn/fc/save/3.1599757114647.mario.nes.sav', function(data) {
        //   nes2 = JSON.parse(data.responseText);
        //   window.nes2 = nes2;
        //   console.log(nes2)
        //   setB2A(nes, nes2);
        // })
        // 本地存储
        if (localStorage[key]) {
          nes2 = JSON.parse(localStorage[key]);
        } else {
          nes2 = window[key];
        }
        // localStorage.nes ? (nes2 = JSON.parse(localStorage.nes)) : '';
        setB2A(nes, nes2);
        // nes.ppu.nameTable = nes2.nameTable;
        // nes.ppu.bgbuffer = nes.bgbuffer;
        // nesSav = JSON.parse(localStorage[`${key}`]);
        // loadCpuMem(nes, nesSav.mem)
        // loadPpuNameTable(nes, nesSav.nameTable)
        // loadMmap(nes, nesSav.mmap)
      } else {
        let userid = localStorage.userid;
        let xhr = new XMLHttpRequest();
        xhr.open('GET', `/market/fc/load/?userid=${userid}&romurl=${encodeURIComponent(key)}`);
        xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
        xhr.onreadystatechange = function (ev) {
          if (xhr.readyState == 4) {
            let result = JSON.parse(ev.target.responseText);
            if (result && result.info && result.info[0]) {
              result.info[0].saveurl
              let xhr = new XMLHttpRequest();
              xhr.open('GET', result.info[0].saveurl)//'/fc/save/88.1600130967879.三国志英杰传(吞食天地1).NES.sav');
              xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
              xhr.onreadystatechange = function (ev) {
                if (xhr.readyState == 4) {
                  nes2 = JSON.parse(ev.target.responseText);
                  localStorage[key] = ev.target.responseText;
                  window.nes2 = nes2;
                  // console.log(nes2)
                  setB2A(nes, nes2);
                }
              }
              xhr.send()
            }
          }
        }
        xhr.send()
      }
    }

    function saveData(config = {}) {
      if (window.isSaving) return;
      key = localStorage.romurl;
      let isAuto = config.isAuto;
      if (isAuto) return;
      // localStorage.clear()
      // localStorage.nes = JSON.stringify(nes);
      let lKeys = Object.keys(localStorage);
      console.log(lKeys);
      // 删除其他存档，防止空间不足无法存储，限制为4M左右，1个存档就有2M了，所以同一时间只有1个游戏的存档，除非之后开发出新的小存储办法，虽然我试过了，小的办法都会漏东西，大的都会在细小的地方有差别 2020-09-09 23:46
      // 现在只要200k了，所以没事了
      // 现在还是改成 没改游戏就读本地，改了 就从服务器读
      for (let i = 0; i < lKeys.length; i++) {
        const key = lKeys[i];
        if (key.indexOf('./rom') > -1) {
          delete localStorage[key];
        }
      }
      delete localStorage['autoSave']

      // localStorage[`${key}-mem`] = JSON.stringify(nes.cpu.mem);
      // localStorage[`${key}-bgbuffer`] = JSON.stringify(nes.ppu.bgbuffer);
      // localStorage[key] = JSON.stringify({
      //   mem: nes.cpu.mem,
      //   nameTable: nes.ppu.nameTable,
      //   mmap: nes.mmap
      // })
      let tar = {
        cpu: nes.cpu,
        nameTable: nes.ppu.nameTable,
        bgbuffer: nes.ppu.bgbuffer,
        mmap: nes.mmap
      };
      if (isAuto) {
        localStorage['autoSave'] = JSON.stringify(tar)
        return;
      } else {
        window.isSaving = true;
        document.getElementById('btnsave').style.opacity = .2;
        try {
          if (key.indexOf('吞') > -1) {
            localStorage[key] = JSON.stringify(tar);
          } else {
            tar = nes;
            localStorage[key] = JSON.stringify(nes)
          }
        } catch (err) {
          console.log(err);
          toast('存档失败了T^T，请联系开发者微信【maqijun123456】', { t: 3000 })
        }
      }
      localStorage.romurl = key;
      $.post({
        url: '/market/fc/save/',
        data: JSON.stringify({
          userid: localStorage.userid,
          save: JSON.stringify(tar),
          romurl: key,
        }),
        contentType: "application/json; charset=utf-8",
        dataType: 'json',
        success: (...args) => {
          console.log(args);
          if (localStorage.isNoNeedLoadTeach != '1') {
            toast('存档成功:P <br>点击屏幕上方方块菜单后，存档按钮会变为读档', { t: 5000 });
          } else {
            toast('存档成功:P', { t: 1000 });
          }
        },
        error: (...args)=>{
          console.log('error', args);
          toast('存档失败' + args[0].toString(), { t: 1000 });
        },
        complete: (...args) => {
          console.log('complete', args);
          window.isSaving = false;
          document.getElementById('btnsave').style.opacity = .5;
        }
      })
      window[key] = nes;
      // localStorage[key] = JSON.stringify(nes);
    }
    $(function () {
      console.log($(document).width()); //浏览器时下窗口文档对于象宽度
      console.log($(document).height()); //浏览器时下窗口文档对于象宽度

      function RingBuffer(capacity, evictedCb) {
        this._elements = new Array(capacity || 50);
        this._first = 0;
        this._last = 0;
        this._size = 0;
        this._evictedCb = evictedCb;
      }
      RingBuffer.prototype.capacity = function () {
        return this._elements.length;
      };
      RingBuffer.prototype.isEmpty = function () {
        return this.size() === 0;
      };
      RingBuffer.prototype.isFull = function () {
        return this.size() === this.capacity();
      };
      RingBuffer.prototype.peek = function () {
        if (this.isEmpty()) throw new Error('RingBuffer is empty');
        return this._elements[this._first];
      };
      RingBuffer.prototype.peekN = function (count) {
        if (count > this._size) throw new Error('Not enough elements in RingBuffer');
        var end = Math.min(this._first + count, this.capacity());
        var firstHalf = this._elements.slice(this._first, end);
        if (end < this.capacity()) {
          return firstHalf;
        }
        var secondHalf = this._elements.slice(0, count - firstHalf.length);
        return firstHalf.concat(secondHalf);
      };
      RingBuffer.prototype.deq = function () {
        var element = this.peek();

        this._size--;
        this._first = (this._first + 1) % this.capacity();

        return element;
      };
      RingBuffer.prototype.deqN = function (count) {
        var elements = this.peekN(count);

        this._size -= count;
        this._first = (this._first + count) % this.capacity();

        return elements;
      };

      RingBuffer.prototype.enq = function (element) {
        this._end = (this._first + this.size()) % this.capacity();
        var full = this.isFull()
        if (full && this._evictedCb) {
          this._evictedCb(this._elements[this._end]);
        }
        this._elements[this._end] = element;

        if (full) {
          this._first = (this._first + 1) % this.capacity();
        } else {
          this._size++;
        }

        return this.size();
      };

      RingBuffer.prototype.size = function () {
        return this._size;
      };

      function Speakers(onBufferUnderrun) {
        this.onBufferUnderrun = onBufferUnderrun;
        this.bufferSize = 8192;
        this.buffer = new RingBuffer(this.bufferSize * 2);
      }
      Speakers.prototype.handleError = function (error, errorInfo) {
        console.error(error);
        // Raven.captureException(error, { extra: errorInfo });
      }
      Speakers.prototype.getSampleRate = function () {
        if (!window.AudioContext) {
          return 44100;
        }
        let myCtx = new window.AudioContext();
        let sampleRate = myCtx.sampleRate;
        myCtx.close();
        return sampleRate;
      }
      Speakers.prototype.start = function () {
        // Audio is not supported
        if (!window.AudioContext && !window.webkitAudioContext) {
          return;
        }
        if (!this.audioCtx) {
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
          this.audioCtx = new window.AudioContext();
          this.scriptNode = this.audioCtx.createScriptProcessor(1024, 0, 2);
          this.scriptNode.onaudioprocess = this.onaudioprocess.bind(this);
          this.scriptNode.connect(this.audioCtx.destination);
        }
      }
      Speakers.prototype.stop = function () {
        if (this.scriptNode) {
          this.scriptNode.disconnect(this.audioCtx.destination);
          this.scriptNode.onaudioprocess = null;
          this.scriptNode = null;
        }
        if (this.audioCtx) {
          this.audioCtx.close().catch(handleError);
          this.audioCtx = null;
        }
      }
      Speakers.prototype.writeSample = function (left, right) {
        if (this.buffer.size() / 2 >= this.bufferSize) {
          // console.log(`Buffer overrun`);
          this.buffer.deqN(this.bufferSize / 2);
        }
        this.buffer.enq(left);
        this.buffer.enq(right);
      };
      Speakers.prototype.onaudioprocess = function (e) {
        var left = e.outputBuffer.getChannelData(0);
        var right = e.outputBuffer.getChannelData(1);
        var size = left.length;
        // We're going to buffer underrun. Attempt to fill the buffer.
        if (this.buffer.size() < size * 2 && this.onBufferUnderrun) {
          this.onBufferUnderrun(this.buffer.size(), size * 2);
        }
        try {
          var samples = this.buffer.deqN(size * 2);
        } catch (e) {
          // onBufferUnderrun failed to fill the buffer, so handle a real buffer
          // underrun
          // ignore empty buffers... assume audio has just stopped
          var bufferSize = this.buffer.size() / 2;
          if (bufferSize > 0) {
            // console.log(`Buffer underrun (needed ${size}, got ${bufferSize})`);
          }
          for (var j = 0; j < size; j++) {
            left[j] = 0;
            right[j] = 0;
          }
          return;
        }
        for (var i = 0; i < size; i++) {
          left[i] = samples[i * 2];
          right[i] = samples[i * 2 + 1];
        }
      };
      // var url = "ws://" + window.location.host + "/ws";
      // var ws = new WebSocket(url);

      // var screen = $("<canvas width='256' height='240'>");
      var screen = $("#canvas");
      // screen[0].style.height ="500px";
      // if (window.innerWidth > 512) {

      // } else {
      let height = window.innerWidth < window.innerHeight*.7 ? window.innerWidth:window.innerHeight*.7
      screen[0].style.height = height + "px";
      // }
      var m = (window.innerWidth / 240 * 256 - window.innerWidth) / 2;
      var n = (window.innerHeight / 240 * 256 - window.innerHeight) / 2;
      // screen[0].style.transform="translate(-50%, -50%)";
      screen[0].style.transform = "rotate(90deg) translate(0px," + m + "px)";
      screen[0].style.left = 0;
      screen[0].style.right = 0;
      screen[0].style.top = 0;
      screen[0].style.bottom = 0;
      screen[0].style.margin = "auto auto";
      window.context = screen[0].getContext('2d');
      setTimeout(()=>{
        var screen = $("#canvas");
        let height = window.innerWidth < window.innerHeight*.7 ? window.innerWidth:window.innerHeight*.7
        screen[0].style.height = height + "px";
        var m = (window.innerWidth / 240 * 256 - window.innerWidth) / 2;
        var n = (window.innerHeight / 240 * 256 - window.innerHeight) / 2;
        // screen[0].style.transform="translate(-50%, -50%)";
        screen[0].style.transform = "rotate(90deg) translate(0px," + m + "px)";
        screen[0].style.left = 0;
        screen[0].style.right = 0;
        screen[0].style.top = 0;
        screen[0].style.bottom = 0;
        screen[0].style.margin = "auto auto";
        window.context = screen[0].getContext('2d');
      }, 3000)
      var imageData = context.getImageData(0, 0, 256, 240);
      // $("#emulator").append(screen);
      this.player = 0;
      window.frame = 0;
      var prevBuffer = new Array(256 * 240);

      window.lastIsChangenge = '';

      function setTime() {
        if (window.lastIsChangenge != window.isChallenge) {
          window.lastIsChangenge = window.isChallenge;
          window.timeDom = window.timeDom || document.getElementById('time');
          if (window.isChallenge) {
            window.timeDom.style.display = 'inline-block';
          } else {
            window.timeDom.style.display = 'none';
          }
        }
        if (!window.isChallenge) {
          return;
        } else {
          window.timeDom = window.timeDom || document.getElementById('time');
          window.timeDom.style.display = 'inline-block';
        }
        if (!startFrame) {
          return;
        }
        // time.innerText = (Date.now() - sTs) - (frame * 16);
        let sms = (frame - startFrame) * 16;
        let ms = ('000' + sms % 1000).substr(-3);
        let ss = Math.floor(sms / 1000);
        let s = ('00' + ss % 60).substr(-2);
        let m = Math.floor(ss / 60);
        // time.innerText = (Date.now() - sTs) - (frame * 16); // 恒定在 63~68 之间，说明时间还算准确
        let usedTime = `${m}:${s}.${ms}`
        time.innerText = usedTime;
        return usedTime;
      }

      let isOk = false;
      let isCatch = false;
      window.isDie = false;
      window.isInDieCheck = false;

      function clearScreen() {
        context.fillStyle = "black";
        context.fillRect(0, 0, 256, 240);
        for (var i = 3; i < imageData.data.length - 3; i += 4) {
          imageData.data[i] = 0xFF;
        }
      }
      window.speakers = new Speakers(
        function (actualSize, desiredSize) {
          if (this.props && this.props.paused) {
            return;
          }
        }
      );
      speakers.start()
      let lastTs = new Date().getTime();
      let sendDic = {};

      function createNes() {
        frame = 0;
        let sTs = Date.now();
        console.log('nes', nes)
        nes = new jsnes.NES({
          onFrame: function (buffer) {
            var data = imageData.data;
            var pixel, i, j;
            let c = 0;
            let transDic = {};
            if (frame > 0) {
              for (i = 0; i < 256 * 240; i++) {
                pixel = buffer[i];
                if (pixel != prevBuffer[i]) {
                  j = i * 4;
                  data[j] = pixel & 0xFF;
                  data[j + 1] = (pixel >> 8) & 0xFF;
                  data[j + 2] = (pixel >> 16) & 0xFF;
                  prevBuffer[i] = pixel;
                  c++
                  transDic[i] = pixel;
                }
              }
              // console.log(c)
              // console.log('transDic', JSON.stringify(transDic).length);
              let len = Object.keys(transDic).length;
              if (len) {
                let ts = new Date().getTime();
                if (ts - lastTs > 200) {
                  // for (i = 0; i < 256 * 240; i++) {
                  //   pixel = buffer[i];
                  //   if (pixel != sendDic[i]) {
                  //     sendDic[i] = pixel;
                  //   }
                  // }
                  lastTs = ts;
                }
              }
              context.putImageData(imageData, 0, 0);
              if (window.isChallenge) {
                if (!isOk) {
                  if (!isDie) {
                    if (startFrame && (frame - startFrame) > 4 * 60) {
                      let leftTopBlack = context.getImageData(10, 36, 1, 1).data;
                      let leftBottomBlack = context.getImageData(240, 220, 1, 1).data;
                      let rightBottomBlack = context.getImageData(10, 220, 1, 1).data;
                      if (leftTopBlack[0] == 0 && leftTopBlack[1] == 0 && leftTopBlack[2] == 0 &&
                        leftBottomBlack[0] == 0 && leftBottomBlack[1] == 0 && leftBottomBlack[2] == 0 &&
                        rightBottomBlack[0] == 0 && rightBottomBlack[1] == 0 && rightBottomBlack[2] == 0) {
                        let marioHat = context.getImageData(105, 105, 1, 1).data;
                        if (marioHat[0] == 188 && marioHat[1] == 25 && marioHat[2] == 0) {
                          isDie = true;
                          if (window.isZZDJS) {
                            toast('录像闯关失败，结束', {
                              t: 10000,
                              isShowConfirmBtn: true,
                              do: () => window.pause = 1,
                              cb: () => {
                                delete window.isZZDJS;
                                window.arr = {};
                                isCatch = false;
                                isOk = false;
                                window.location.reload();
                              }
                            });
                          } else {
                            let xhr = new XMLHttpRequest();
                            xhr.open('POST', '/market/fc/setWin');
                            xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
                            xhr.onreadystatechange = function (ev) {
                              if (xhr.readyState == 4) {
                                console.log(ev.target.response)
                              }
                            }
                            xhr.send(JSON.stringify({
                              "userid": localStorage.userid,
                              "step": localStorage.arr,
                              "usetime": 999 * 1000
                            }))
                            toast('已阵亡，少侠请重新来过', {
                              t: 10000,
                              isShowConfirmBtn: true,
                              do: () => window.pause = 1,
                              cb: () => {
                                window.location.reload();
                              }
                            });
                            return;
                          }
                        }
                      }
                    }
                  } else {
                    return;
                  }
                  if (!isCatch) {
                    for (let i = 0; i < 10; i++) {
                      let a = context.getImageData(200 + i, 72, 1, 1).data;
                      if (a[0] == 117 && a[1] == 227) {
                        isCatch = true;
                        console.log('okok')
                        console.log('a', a);
                      }
                    }
                  }
                  if (isCatch) {
                    let lastR;
                    for (let i = 0; i < 200; i++) {
                      let r = context.getImageData(40 + i, 186, 1, 1).data[0];
                      if (r == 117 && lastR == 255) {
                        if (!isOk) {
                          isOk = true;
                          let time = setTime();
                          if (window.isZZDJS) {
                            toast('录像闯关成功', {
                              t: 10000,
                              isShowConfirmBtn: true,
                              do: () => window.pause = 1,
                              cb: () => {
                                delete window.isZZDJS;
                                window.arr = {};
                                isCatch = false;
                                isOk = false;
                                window.location.reload();
                              }
                            });
                          } else {
                            let xhr = new XMLHttpRequest();
                            xhr.open('POST', '/market/fc/setWin');
                            xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
                            xhr.onreadystatechange = function (ev) {
                              if (xhr.readyState == 4) {
                                console.log(ev.target.response)
                              }
                            }
                            let usetimeS = (Number(time.split(':')[0]) * 60 + Number(time.split(':')[
                              1]))
                            xhr.send(JSON.stringify({
                              "userid": localStorage.userid,
                              "step": localStorage.arr,
                              "usetime": usetimeS * 1000
                            }))
                            window.pause = 1;
                            isCatch = false;
                            isOk = false;
                            localStorage.isShowRedPack = localStorage.isShowRedPack || '';
                            let redPacks = ['Tekii模拟器马里奥30秒通过达成']
                            if (usetimeS < 30 && !localStorage.isShowRedPack) {
                              localStorage.isShowRedPack = redPacks[Math.random() * redPacks.length | 0];
                              toast('恭喜，你用时：' + time + '\n支付宝口令红包为：【' + localStorage
                                .isShowRedPack + '】', {
                                t: 10000,
                                isShowConfirmBtn: true,
                              do: () => window.pause = 1,
                                cb: () => {
                                  window.location.reload();
                                }
                              });
                            } else {
                              toast('恭喜，你用时：' + time, {
                                t: 10000,
                                isShowConfirmBtn: true,
                                do: () => window.pause = 1,
                                cb: () => {
                                  window.location.reload();
                                }
                              });
                            }
                          }
                        }
                      }
                      lastR = r;
                    }
                  }
                }
              }
              // ctx.strokeRect(200, 72, 12, 16);
              // goPikachu()
            }
            frame += 1;
            setTime();
            let _arr = arr[frame] || [];
            for (let i = 0; i < _arr.length; i++) {
              if (_arr.length) { console.log(_arr) }
              const tar = _arr[i];
              if (tar[2] == 'u') {
                nes.buttonUp(tar[0], tar[1], true, {
                  isVedio: true
                })
              } else if (tar[2] == 'd') {
                nes.buttonDown(tar[0], tar[1], true, {
                  isVedio: true
                })
              }
            }
            // if (frame < 2500) {
            //   console.log(frame);
            //   nes.frame()
            // }
            // send at 30 fps
            // if (frame === 2) {
            //   // sendScreen();
            //   // drawData(data);
            //   frame = 0;
            // }
            // 测试自动存储
            // if (frame > 500 && frame % 100 == 0 && isNesIn) {
            //   console.log('save frame', nes);
            //   localStorage.nes = JSON.stringify(nes);
            // }
          },
          onAudioSample: (...arg) => {
            // console.log(arg);
            speakers.writeSample.bind(speakers)(...arg)
          },
          sampleRate: speakers.getSampleRate()
        });

        let srcButtonUp = nes.buttonUp;
        let srcButtonDown = nes.buttonDown;

        window.arr = {};
        // if (localStorage.arr) {
        //   window.arr = JSON.parse(localStorage.arr);
        // }
        nes.buttonUp = (k0, k1, isNoEmit, config = {}) => {
          console.log('buttonUp', k0, k1, isNoEmit, config)
          if (window.isZZDJS && !config.isVedio) {
            // 演示他人视频时，不能操控
            return;
          }
          if (!config.isVedio) {
            arr[frame] = arr[frame] || [];
            arr[frame].push([k0, k1, 'u']);
            localStorage.arr = JSON.stringify(arr);
          }
          if (k0 == 1) {
            document.getElementById(keyDomDic[k1]).classList.remove('active')
          }
          let id = Math.random().toString().substr(2, 3);
          let fpsDic = window.fpsDic || {}
          fpsDic[id] = Date.now()
          let m_p = window.playerId;
          let m_f = nes.f;
          let m_b = !isNoEmit && socket.emit("m", {
            key: [k0, k1],
            type: "up",
            ts: Date.now(),
            id,
            cId: window.cId,
            uId: localStorage.userid,
            rom: window.romurl,
            p: window.playerId,
            f: nes.f,
            m: ""
          });
          window.fpsDic = fpsDic;
          if (window.playerId == 2 && !config.isVedio) {
            // 自己控制P2，行为需要等P1处理后返回，相当于放vedio
            return;
          }
          srcButtonUp(k0, k1);
        }
        nes.buttonDown = (k0, k1, isNoEmit, config = {}) => {
          console.log(k0, k1)
          if (window.isZZDJS && !config.isVedio) {
            // 演示他人视频时，不能操控
            return;
          }
          if (!config.isVedio) {
            arr[frame] = arr[frame] || [];
            arr[frame].push([k0, k1, 'd']);
            localStorage.arr = JSON.stringify(arr);
          }
          if (!startFrame && keyDomDic[k1] == 'btnstart') {
            startFrame = frame;
          }
          if (k0 == 1) {
            document.getElementById(keyDomDic[k1]).classList.add('active')
          }
          let id = Math.random().toString().substr(2, 3);
          let fpsDic = window.fpsDic || {}
          fpsDic[id] = Date.now();
          !isNoEmit && socket.emit('m', {
            key: [k0, k1],
            type: 'down',
            ts: Date.now(),
            cId: window.cId,
            uId: localStorage.userid,
            rom: window.romurl,
            id,
            p: window.playerId,
            f: nes.f
          })
          window.fpsDic = fpsDic;
          if (window.playerId == 2 && !config.isVedio) {
            // 自己控制P2，行为需要等P1处理后返回，相当于放vedio
            return;
          }
          srcButtonDown(k0, k1)
        }
      }

      function loadGames() {
        // $.getJSON('/gamelist', function (data) {
        var data = {
          games: ['lj65.nes']
        }
        var html = '';
        var len = data.games.length;
        for (var i = 0; i < len; i++) {
          html += '<option value="' + data.games[i] + '">' + data.games[i].replace(".nes", "") + '</option>';
        }
        $('#current-game').append(html);
        // });
      }

      function loadROM(url) {
        $.ajax({
          url: escape(url),
          xhr: function () {
            var xhr = $.ajaxSettings.xhr();
            xhr.overrideMimeType('text/plain; charset=x-user-defined');
            return xhr;
          },
          complete: function (xhr, status) {
            nes.loadROM(xhr.responseText);
            nes.start();
          }
        });
      }

      function triggerKey(type, keyCode) {
        var e = jQuery.Event(type);
        e.which = keyCode;
        e.keyCode = keyCode;
        $(document).trigger(e);
      }

      function sendKey(type, keyCode) {
        ws.send(type + " " + keyCode);
      }

      function sendScreen(buffer) {
        var image = screen[0].toDataURL();
        ws.send("data " + image);
      }

      function drawData(data) {
        var img = new Image();
        img.src = data;
        context.drawImage(img, 0, 0);
      }

      function startPlaying(data) {
        window.player = parseInt(data, 10);
        if (window.player == 1) {
          newGame();
          $("#games-list").show();
          $("#message").text("You are Player 1");
        }
        if (window.player == 2) {
          $("#games-list").hide();
          $("#message").text("You are Player 2");
        }
      }

      function newGame() {
        var rom = document.getElementById("current-game").value;
        if (window.player == 1 && rom != "") {
          clearScreen();
          createNes();
          loadROM("/games?name=" + rom);
        }
      }
      window.newGame = newGame;

      function stopPlaying() {
        if (nes !== null) {
          nes.stop();
          nes = null;
        }
        clearScreen();
        window.player = 0;
        $("#message").text("Waiting for Player 2");
      }
      // ws.onmessage = function (msg) {
      //   var parts = msg.data.split(" ");
      //   var cmd = parts[0];
      //   var data = parts[1];

      //   if (cmd === "join") {
      //     startPlaying(data);
      //   }

      //   if (cmd === "part") {
      //     stopPlaying();
      //   }

      //   if (cmd === "keyup" || cmd === "keydown") {
      //     triggerKey(cmd, parseInt(data, 10));
      //   }

      //   if (cmd === "data") {
      //     drawData(data);
      //   }
      // };
      var keyMap = {
        88: 103,
        90: 105,
        17: 99,
        13: 97,
        38: 104,
        40: 98,
        37: 100,
        39: 102
      };

      const KEYS = {
        88: [1, jsnes.Controller.BUTTON_A, "X"], // X
        89: [1, jsnes.Controller.BUTTON_B, "Y"], // Y (Central European keyboard)
        90: [1, jsnes.Controller.BUTTON_B, "Z"], // Z
        17: [1, jsnes.Controller.BUTTON_SELECT, "Right Ctrl"], // Right Ctrl
        13: [1, jsnes.Controller.BUTTON_START, "Enter"], // Enter
        38: [1, jsnes.Controller.BUTTON_UP, "Up"], // Up
        40: [1, jsnes.Controller.BUTTON_DOWN, "Down"], // Down
        37: [1, jsnes.Controller.BUTTON_LEFT, "Left"], // Left
        39: [1, jsnes.Controller.BUTTON_RIGHT, "Right"], // Right

        103: [2, jsnes.Controller.BUTTON_A, "Num-7"], // Num-7
        105: [2, jsnes.Controller.BUTTON_B, "Num-9"], // Num-9
        99: [2, jsnes.Controller.BUTTON_SELECT, "Num-3"], // Num-3
        97: [2, jsnes.Controller.BUTTON_START, "Num-1"], // Num-1
        104: [2, jsnes.Controller.BUTTON_UP, "Num-8"], // Num-8
        98: [2, jsnes.Controller.BUTTON_DOWN, "Num-2"], // Num-2
        100: [2, jsnes.Controller.BUTTON_LEFT, "Num-4"], // Num-4
        102: [2, jsnes.Controller.BUTTON_RIGHT, "Num-6"] // Num-6
      };
      window.KEYS = KEYS;
      const keyDomDic = {
        0: 'btna',
        1: 'btnb',
        2: 'btnselect',
        3: 'btnstart',
        4: 'btnup',
        5: 'btndown',
        6: 'btnleft',
        7: 'btnright'
      }
      $(document).bind("contextmenu", function (evt) {
        evt.preventDefault();
      })
      // localStorage.step = '';

      $(document).bind("keydown", function (evt) {

        var key = KEYS[evt.keyCode];
        if (key) {
          nes.buttonDown(key[0], key[1]);
        }
      });

      $(document).bind("keyup", function (evt) {
        var key = KEYS[evt.keyCode];
        if (key) {
          nes.buttonUp(key[0], key[1]);
        }
      });
      // $('#btnall').bind("touchstart mousedown", function (evt) {
      //   console.log('touchstart');
      //   console.log(evt);
      //   // evt.preventDefault();
      //   // nes.buttonDown(KEYS[38][0], KEYS[38][1]);

      // });
      // $('#btnall').bind("touchmove mousemove", function (evt) {
      //   // console.log('touch');
      //   // console.log(evt);
      //   // evt.preventDefault();
      //   // nes.buttonDown(KEYS[38][0], KEYS[38][1]);

      // });
      // $('#btnall').bind("touchend mouseup", function (evt) {
      //   console.log('touchend');
      //   console.log(evt);
      //   // evt.preventDefault();
      //   // nes.buttonDown(KEYS[38][0], KEYS[38][1]);

      // });

      var touchDic = {
        'btnup': 0,
        'btnright': 0,
        'btn12': 0,
        'btn14': 0,
        'btndown': 0,
        'btnleft': 0,
        'btn23': 0,
        'btn34': 0,
        'btna': 0,
        'btnb': 0
      }
      // 直接添加监听事件
      $(document).on('touchstart', function (e) {
        let touches = e.originalEvent.touches;
        touchBtn(touches);
        // e.stopPropagation();
        // return false;
      })
      $(document).on('touchend', function (e) {
        let touches = e.originalEvent.touches;
        // console.log('touchend', touches, e)
        touchBtn(touches, 'touchend');
        // e.stopPropagation();
        // return false;
      })

      $(document).on('touchmove', function (e) {
        let touches = e.originalEvent.touches;
        touchBtn(touches);
        // console.log('touchmove', touches, e)
        // e.stopPropagation();
        // return false;
      })

      function touchBtn(touches, type) {
        console.log(touches)
        console.log(type)
        // ['btnup', 'btnright', 'btn12', 'btn14', 'btndown', 'btnleft', 'btn23', 'btn34', 'btna', 'btnb']
        for (let i = 0; i < touches.length; i++) {
          const tarTouch = touches[i];
          // toast(`${tarTouch.pageX} ${tarTouch.pageY}|${tarTouch.screenX} ${tarTouch.screenY}|`)
          let x = tarTouch.clientX;
          let y = tarTouch.clientY;
          let dom = document.elementFromPoint(x, y);
          if (touchDic[dom.id] === 0) {
            touchDic[dom.id] = 3; // 待处理
          }
          if (touchDic[dom.id] === 1) {
            touchDic[dom.id] = 2; // 已处理
          }
        }
        for (const i in touchDic) {
          if (type) {
            console.log(i, touchDic[i])
          }
          if (touchDic.hasOwnProperty(i)) {
            const tarTouch = touchDic[i];
            if (touchDic[i] === 1) {
              touchDic[i] = 0;
              // document.getElementById(i).classList.remove('active') // 已改到函数里面加状态
              processBtn({
                id: i
              }, 0) // 抬起
            }
            if (touchDic[i] === 2) {
              touchDic[i] = 1;
            }
          }
        }
        for (const i in touchDic) {
          if (touchDic[i] === 3) {
            // document.getElementById(i).classList.add('active') // 已改到函数里面加状态
            processBtn({
              id: i
            }, 1) // 按下
            touchDic[i] = 1; // 已按下
          }
        }
        console.log(touchDic);
        return false;
      }
      let playerId = window.playerId;

      function processBtn(dom, isDown, playerId) {
        playerId = playerId || window.playerId;
        console.log(arguments);
        let tarFunc;
        if (isDown) {
          tarFunc = nes.buttonDown;
        } else {
          tarFunc = nes.buttonUp;
        }

        if (dom.id == 'btnup') {
          tarFunc(playerId, KEYS[38][1]);
        }
        if (dom.id == 'btnright') {
          tarFunc(playerId, KEYS[39][1]);
        }
        if (dom.id == 'btn12') {
          tarFunc(playerId, KEYS[38][1]);
          tarFunc(playerId, KEYS[39][1]);
        }
        if (dom.id == 'btn14') {
          tarFunc(playerId, KEYS[38][1]);
          tarFunc(playerId, KEYS[37][1]);
        }
        if (dom.id == 'btndown') {
          tarFunc(playerId, KEYS[40][1]);
        }
        if (dom.id == 'btnleft') {
          tarFunc(playerId, KEYS[37][1]);
        }
        if (dom.id == 'btn23') {
          tarFunc(playerId, KEYS[39][1]);
          tarFunc(playerId, KEYS[40][1]);
        }
        if (dom.id == 'btn34') {
          tarFunc(playerId, KEYS[40][1]);
          tarFunc(playerId, KEYS[37][1]);
        }
        if (dom.id == 'btna') {
          tarFunc(playerId, KEYS[88][1]);
        }
        if (dom.id == 'btnb') {
          tarFunc(playerId, KEYS[89][1]);
        }
      }
      let twoPlayerRomList = [
        './rom/Chip To Dale No Daisakusen 2 (J).nes',
        './rom/Double Dragon (U).nes',
        './rom/iceclimb.nes',
        './rom/Battle City (J).nes',
        './rom/CONTRA.NES',
        './rom/Kunio_Kun_no_Nekketsu_Soccer_League_(J)(T+C)(AirTeam)build_070217.nes',
        './rom/BOMBMAN.NES',
        './rom/Bomberman 2 (U).nes',
        './rom/smbc.nes',
      ]
      if (twoPlayerRomList.indexOf(localStorage.romurl) > -1) {
        $('#changePlayer').css('display', 'inline-block')
      }
      $('#changePlayer').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        if (window.playerId == 2) {
          window.playerId = 1;
          $('#changePlayer').css('background-image', "url('./img/player1.png')");
        } else {
          window.playerId = 2;
          $('#changePlayer').css('background-image', "url('./img/player2.png')");
          socket.emit("m", {
            hb: 2, // 标记为心跳包heart beat
            p2: 1,
            uId: localStorage.userid,
            rom: window.romurl,
            f: nes.f,
          });
        }
        // if (window.playerId == 2) {
        //   document.getElementById('canvas').style.display = 'none';
        //   document.getElementById('canvasTips').innerHTML = '<span>请看P1的屏幕</span>';
        // } else {
        //   document.getElementById('canvasTips').innerText = ''
        //   document.getElementById('canvas').style.display = 'block';
        // }
      });
      $('#changePlayer').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });

      $('#btnsave').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        saveData()
      });
      $('#btnsave').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });
      $('#btnload').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        loadSavedData();
        localStorage.isNoNeedLoadTeach = '1';
      });
      $('#btnload').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });
      $('#btnspeed').bind("touchstart mousedown", function (evt) {
        if (frameSpeed == 1) {
          frameSpeed = 5;
          $('#btnspeed').addClass('open');
        } else {
          frameSpeed = 1;
          $('#btnspeed').removeClass('open');
        }
        evt.preventDefault();
        // clearInterval(autoSaveInter)
        // localStorage.clear()
      });
      $('#btnspeed').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });

      $('#btnselect').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        nes.buttonDown(KEYS[17][0], KEYS[17][1]);
        socket.emit("message", {
          type: "down",
          key: [KEYS[17][0], KEYS[17][1]]
        })
        if (speakers.audioCtx)
          speakers.audioCtx.resume();
      });
      $('#btnselect').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
        nes.buttonUp(KEYS[17][0], KEYS[17][1]);
        socket.emit("message", {
          type: "up",
          key: [KEYS[17][0], KEYS[17][1]]
        })
      });
      $('#btnstart').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        nes.buttonDown(KEYS[13][0], KEYS[13][1]);
        socket.emit("message", {
          type: "down",
          key: [KEYS[13][0], KEYS[13][1]]
        })
        if (speakers.audioCtx)
          speakers.audioCtx.resume();
      });
      $('#btnstart').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
        nes.buttonUp(KEYS[13][0], KEYS[13][1]);
        socket.emit("message", {
          type: "up",
          key: [KEYS[13][0], KEYS[13][1]]
        })
      });
      $('#config-btn').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        isConfigShow = !isConfigShow;
        if (isConfigShow) {
          $('#game-list-box').show();
          $('#btnsave').hide();
          $('#btnload').show();
        } else {
          $('#game-list-box').hide();
          $('#btnsave').show();
          $('#btnload').hide();
        }
      });

      clearScreen();
      createNes();

      function loadBinary(path, callback, handleProgress) {
        $.ajax({
          url: '/market/fc/log?type=loadBinary&remark=' + localStorage.userid + ' ' + path
        });
        var req = new XMLHttpRequest();
        req.open("GET", path);
        req.overrideMimeType("text/plain; charset=x-user-defined");
        req.onload = function () {
          if (this.status === 200) {
            if (req.responseText.match(/^<!doctype html>/i)) {
              // Got HTML back, so it is probably falling back to index.html due to 404
              return callback(new Error("Page not found"));
            }
            callback(null, this.responseText);
          } else if (this.status === 0) {
            // Aborted, so ignore error
          } else {
            callback(new Error(req.statusText));
          }
        };
        req.onerror = function () {
          callback(new Error(req.statusText));
        };
        req.onprogress = handleProgress;
        req.send();
        return req;
      }

      loadBinary(romurl, (err, data) => {
        if (err) {
          // this.setState({ error: `Error loading ROM: ${err.message}` });
          console.log(err);
        } else {
          nes.loadROM(data);
          // loadSavedData({isAuto: true}) // 自动读取有莫名奇妙的问题
          window.nesInterval = setInterval(function () {
            goF(nes);
            if (frameSpeed == 5) {
              goF(nes);
              goF(nes);
            }
            if (!window.isChallenge && (frame % 100 == 0)) {
              let ms = Date.now() - window.ts;
              let f = frame - window.lastF;
              time.style.display = 'inline-block';
              // console.log(ms, frame, ms / frame);
              ms / f ? (time.innerText = (f * 1000 / (ms)).toFixed(2)) : '';
              window.ts = Date.now();
              window.lastF = frame;
            }
          }, 16);
          // 重要！！！ 这里可以证明 只要把整个 nes存下来 就可以 做到存档
          // setTimeout(()=>{
          //   nes2 = nes;
          //   createNes();
          //   nes.loadROM(data);
          // }, 15000)
          // setTimeout(()=>{
          //   nes = nes2;
          // }, 20000)
          // console.log("nes2['cpu']['mem']", nes2['cpu']['mem'])
          // nes['cpu']['mem'] = nes2['cpu']['mem'];
          let c = 0;
          /// 哇塞塞！！！好像成功了耶
          // for (const key in nes2) {
          //   c++
          //   if (c==4) {
          //     console.log('key', key);
          //     const element = nes2[key];
          //     let d = 0;
          //     for (const key2 in element) {
          //       // if (element.hasOwnProperty(key2)) {
          //       //   const element2 = element[key2];
          //       //   nes[key] = nes[key] || nes2[key];
          //       //   nes[key][key2] = element2;
          //       // }
          //       console.log(key2);
          //     }
          //     continue;
          //   }
          //   if (nes2.hasOwnProperty(key) && c != 4) {
          //     console.log(key);
          //     const element = nes2[key];
          //     for (const key2 in element) {
          //       if (element.hasOwnProperty(key2)) {
          //         const element2 = element[key2];
          //         nes[key] = nes[key] || nes2[key];
          //         nes[key][key2] = element2;
          //       }
          //     }
          //   }
          // }
          // 不自动读档，在config里面，去点击读档
          // setB2A(nes, nes2);
          // this.handleLoaded(data);
        }
      }, null)

      window.onunload = function () {
        if (interval)
          clearInterval(interval);
        speakers.stop();
        console.log('onunload');
      };
    });

    function doSth(key) {

    }
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // 暂时关闭联机功能
    let socket = {
      emit: function emit(...args) {
        console.log('emit', args);
      },
    }
    // socket = io.connect('ws://192.168.1.47:3000');
    // socket = io.connect('ws://192.168.0.3:3000');
    socket = io.connect('//tekii.cn/');
    socket.emit("m", {
      "name": navigator.userAgent,
      "msg": "hello world"
    });
    setInterval(() => {
      if (window.playerId == 1 && nes && nes.f && window.hasP2) {
        socket.emit("m", {
          hb: 1, // 标记为心跳包heart beat
          uId: localStorage.userid,
          rom: window.romurl,
          f: nes.f,
        });
      }
    }, 16)
    socket.on("m", function (obj) {
      // return;
      if (obj.uId == '184') {
        return;
      }
      console.log(obj);
      let key = obj.key;
      let fpsDic = window.fpsDic || {}
      console.log('obj.id', obj.id, fpsDic[obj.id])
      let lTs = obj.ts //fpsDic[obj.id];
      let nTs = Date.now();
      console.log(nTs, lTs, nTs - lTs)
      fps.value = (nTs - lTs).toFixed(2) + 'ms';
      // while (nes.f < obj.f) {
      //   goF(nes); // 追上队友的frameCount
      // }
      if (obj.cId == window.cId) {
        return;
      }
      if (obj.hb) {
        if (obj.p2 && obj.rom == localStorage.romurl) {
          window.hasP2 = true;
          return;
        }
        if (window.playerId == 2) {
          window.maxF = obj.f;
        }
        return;
      }
      if (window.playerId == 1) {
        if (key && key[0] == 2 && obj.p == 2 && obj.rom == localStorage.romurl) { // 只有p2的指令才会传进游戏
          if (obj.type == 'up') {
            nes.buttonUp(key[0], key[1]);
          } else if (obj.type == 'down') {
            nes.buttonDown(key[0], key[1]);
          }
        }
      } else {
        if (obj.p == 1 && obj.rom == localStorage.romurl) {
          window.arr[obj.f] = window.arr[obj.f] || [];
          window.arr[obj.f].push([key[0], key[1], obj.type == 'up' ? 'u' : 'd']);
          window.maxF = obj.f;
          while (nes.f < obj.f - 2) {
            goF(nes); // 追上队友的frameCount
          }
        }
      }
    });
    socket.on("u", function (obj) {
      console.log('u', obj);
      window.auc = window.auc || obj.auc;
      if (obj.auc > window.auc) {
        addCoin();
        window.auc = obj.auc;
      } else {
        // 人数变少了，不加币也不赋值
      }
    })
    socket.on("w", function (obj) {
      if (window.tid == obj.tid) {
        switch (obj.action) {
          case 'subCoin':
            subCoin();
            break;
          case 'addCoin':
            addCoin();
            break;
        }
      }
    })
  </script>
</body>

</html>
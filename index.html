<!DOCTYPE html>
<html lang="en" style="position: fixed;width: 100vw;height: 100vh;left: 0;top: 0;">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport" />
  <!-- <script src="https://www.norchant.com/js/vconsole.min.js"></script> -->
  <title>红白机模拟器</title>
  <style>
    body {
      overflow: hidden;
      background-color: black;
    }

    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    #emulator {
      margin: 0 auto;
      width: 100%;
    }

    #canvas {
      position: fixed;
      /* width: 100%; */
      /* transform: rotate(90deg); */
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: 0 auto;
    }

    #message {
      font-family: sans-serif;
      padding: 30px;
      font-weight: 500;
    }

    #keys {
      font-size: 14px;
      font-family: sans-serif;
      padding-bottom: 15px;
    }

    #games-list {
      padding-bottom: 15px;
    }

    #game-list-box {
      display: none;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: -140px;
      width: 50vw;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      opacity: .8;
      transform: rotateZ(90deg);
    }

    #game-list {
      margin-top: 0;
      height: 60vw;
      overflow: auto;
      background-color: black;
    }

    #game-list-box p {
      margin: 0;
      height: 3rem;
      font-size: 1.5rem;
      line-height: 3rem;
      color: #ffffff;
      border: 1px solid #ffffff;
    }
  </style>
</head>

<body>
  <canvas id="canvas" width='256px' height='240px'></canvas>
  <!-- <div id="btnall"
    style="opacity:0.5;width:45vw;height:45vw;background-size:45vw 45vw;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:5vw;top:5vw;transform: rotate(90deg);">
  </div> -->
  <div class="btn" id="btnup"
    style="opacity:0.5;width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:35vw;top:20vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btnright"
    style="opacity:0.5;width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:20vw;top:35vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btn12"
    style="width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:35vw;top:35vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btndown"
    style="opacity:0.5;width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:5vw;top:20vw;transform: rotate(270deg);">
  </div>
  <div class="btn" id="btn23"
    style="width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:5vw;top:35vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btnleft"
    style="opacity:0.5;width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:20vw;top:5vw;">
  </div>
  <div class="btn" id="btn34"
    style="width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:5vw;top:5vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btn14"
    style="width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:35vw;top:5vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btnsave"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/btnsave.png');background-repeat:no-repeat;position:fixed;right:2vw;top:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btnload"
    style="display:none;opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/btnload.png');background-repeat:no-repeat;position:fixed;right:2vw;top:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btnspeed"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/btnspeed.png');background-repeat:no-repeat;position:fixed;right:2vw;top:35vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btnselect"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/btnselect.png');background-repeat:no-repeat;position:fixed;right:2vw;bottom:35vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btnstart"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/btnstart.png');background-repeat:no-repeat;position:fixed;right:2vw;bottom:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btnb"
    style="opacity:0.5;width:20vw;height:20vw;background-size:20vw 20vw;background-image:url('./img/btnb.png');background-repeat:no-repeat;position:fixed;left:5vw;bottom:26vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btna"
    style="opacity:0.5;width:20vw;height:20vw;background-size:20vw 20vw;background-image:url('./img/btna.png');background-repeat:no-repeat;position:fixed;left:5vw;bottom:5vw;transform: rotate(90deg);">
  </div>
  <div class="config-btn" id="config-btn"
    style="opacity: 0.5;width: 6vh;height: 6vh;background-size: 100% 100%;background-image: url(./img/config.png);background-repeat: no-repeat;position: fixed;top: 47vh;right: -3vw;transform: rotate(90deg);">
  </div>
  <div class="game-list-box" id="game-list-box">
    <div class="game-list" id="game-list">
      <p
        onclick="localStorage.romurl = './rom/Chip To Dale No Daisakusen 2 (J).nes';window.location.href = window.location.href;">
        松鼠大作战</p>
      <p onclick="localStorage.romurl = './rom/mario.nes';window.location.href = window.location.href;">马里奥</p>
      <p onclick="localStorage.romurl = './rom/希特勒复活.nes';window.location.href = window.location.href;">希特勒复活</p>
      <p onclick="localStorage.romurl = './rom/c31.nes';window.location.href = window.location.href;">中国象棋</p>
      <p onclick="localStorage.romurl = './rom/Double Dragon (U).nes';window.location.href = window.location.href;">
        双截龙1(美版)</p>
      <p onclick="localStorage.romurl = './rom/Yie Ar Kung-Fu (J).nes';window.location.href = window.location.href;">功夫
      </p>
      <p onclick="localStorage.romurl = './rom/iceclimb.nes';window.location.href = window.location.href;">雪人兄弟</p>
      <p
        onclick="localStorage.romurl = './rom/Dragonlance - Dragons of Flame (J).nes';window.location.href = window.location.href;">
        龙之矛-龙的火焰</p>
      <p onclick="localStorage.romurl = './rom/vs dr mario.nes';window.location.href = window.location.href;">马里奥医生</p>
      <p onclick="localStorage.romurl = './rom/马戏团.nes';window.location.href = window.location.href;">马戏团(中文)</p>
      <p onclick="localStorage.romurl = './rom/Makaimura (J).nes';window.location.href = window.location.href;">魔界村</p>
      <p onclick="localStorage.romurl = './rom/Battle City (J).nes';window.location.href = window.location.href;">坦克大战
      </p>
      <p onclick="localStorage.romurl = './rom/CONTRA.NES';window.location.href = window.location.href;">魂斗罗</p>
      <p onclick="localStorage.romurl = './rom/NINJAGA3.NES';window.location.href = window.location.href;">忍者龙剑传3</p>
      <!-- This ROM uses a mapper not supported by JSNES: Namcot 106 chip(19) -->
      <!-- <p onclick="localStorage.romurl = './rom/Sangokushi 2.nes';window.location.href = window.location.href;">三国志2霸王的大陆</p> -->



    </div>
  </div>
  <style>
    .btn:active {
      opacity: 0.2 !important;
    }
  </style>
  <!-- <script type="text/javascript" src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script> -->
  <script type="text/javascript" src="./js/jsnes.min.js"></script>
  <!-- <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.0.min.js"></script> -->
  <script type="text/javascript" src="./js/jquery-3.4.0.min.js"></script>
  <script>
    /**
     * TODO::
     *   音频无法播放 The AudioContext was not allowed to start（手机端加载存档后 直接也没声音）
     *   更流畅的双屏联机功能
     *   代码简化
     *   游戏选择功能
     *   重启游戏功能
     *   回放功能
     *   后台存储存档/存储nes文件
     */
    // 是否记录操作，不是 就自动按按钮
    let isIn = true;
    let steps = {};
    if (!isIn) {
      steps = JSON.parse(localStorage.steps);
    }
    // 是否是存入档案阶段，不是 就自动读档
    let isNesIn = false;
    var nes = null;
    var nes2 = null;
    if (!isNesIn) {
      localStorage.nes ? (nes2 = JSON.parse(localStorage.nes)) : '';
    }
    // 加载速度
    let frameSpeed = 1;
    let isConfigShow = false;
    var interval;
    function setB2A(a, b) {
      for (const key in b) {
        if (b.hasOwnProperty(key)) {
          const bV = b[key];
          if (bV instanceof Object) {
            if (a[key]) {
              // 透明度好了 step1 加上了这个好了
              if (key == 'opaque') {
                return;
                console.log('keykeykeyk', opaque)
              }
              setB2A(a[key], b[key]);
            } else {
              // a[key] = {};
              // 这个地方很神奇，如果转换了 就报错了Cannot read property 'opaque' of undefined，但能显示主角，不显示背景
              // 如果把这里注释掉，就能显示背景，但主角和怪物什么的 都会变成马赛克
              a[key] = {}; // 透明度好了 step2 加上了这个好了
              setB2A(a[key], b[key]);
              // console.log('key', key, bV)
            }
          } else {
            a[key] = b[key];
          }
        }
      }
    }
    function loadSavedData() {
      setB2A(nes, nes2);
    }
    $(function () {
      // var romurl = "https://bmob-cdn-22939.bmobcloud.com/2019/06/23/7184934a405e956a804a676bc29c15ba.nes";
      var romurl = localStorage.romurl ? localStorage.romurl : "./rom/mario.nes";
      console.log($(document).width());//浏览器时下窗口文档对于象宽度
      console.log($(document).height());//浏览器时下窗口文档对于象宽度

      function RingBuffer(capacity, evictedCb) {
        this._elements = new Array(capacity || 50);
        this._first = 0;
        this._last = 0;
        this._size = 0;
        this._evictedCb = evictedCb;
      }
      RingBuffer.prototype.capacity = function () {
        return this._elements.length;
      };
      RingBuffer.prototype.isEmpty = function () {
        return this.size() === 0;
      };
      RingBuffer.prototype.isFull = function () {
        return this.size() === this.capacity();
      };
      RingBuffer.prototype.peek = function () {
        if (this.isEmpty()) throw new Error('RingBuffer is empty');
        return this._elements[this._first];
      };
      RingBuffer.prototype.peekN = function (count) {
        if (count > this._size) throw new Error('Not enough elements in RingBuffer');
        var end = Math.min(this._first + count, this.capacity());
        var firstHalf = this._elements.slice(this._first, end);
        if (end < this.capacity()) {
          return firstHalf;
        }
        var secondHalf = this._elements.slice(0, count - firstHalf.length);
        return firstHalf.concat(secondHalf);
      };
      RingBuffer.prototype.deq = function () {
        var element = this.peek();

        this._size--;
        this._first = (this._first + 1) % this.capacity();

        return element;
      };
      RingBuffer.prototype.deqN = function (count) {
        var elements = this.peekN(count);

        this._size -= count;
        this._first = (this._first + count) % this.capacity();

        return elements;
      };

      RingBuffer.prototype.enq = function (element) {
        this._end = (this._first + this.size()) % this.capacity();
        var full = this.isFull()
        if (full && this._evictedCb) {
          this._evictedCb(this._elements[this._end]);
        }
        this._elements[this._end] = element;

        if (full) {
          this._first = (this._first + 1) % this.capacity();
        } else {
          this._size++;
        }

        return this.size();
      };

      RingBuffer.prototype.size = function () {
        return this._size;
      };

      function Speakers(onBufferUnderrun) {
        this.onBufferUnderrun = onBufferUnderrun;
        this.bufferSize = 8192;
        this.buffer = new RingBuffer(this.bufferSize * 2);
      }
      Speakers.prototype.handleError = function (error, errorInfo) {
        console.error(error);
        // Raven.captureException(error, { extra: errorInfo });
      }
      Speakers.prototype.getSampleRate = function () {
        if (!window.AudioContext) {
          return 44100;
        }
        let myCtx = new window.AudioContext();
        let sampleRate = myCtx.sampleRate;
        myCtx.close();
        return sampleRate;
      }
      Speakers.prototype.start = function () {
        // Audio is not supported
        if (!window.AudioContext && !window.webkitAudioContext) {
          return;
        }
        if (!this.audioCtx) {
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
          this.audioCtx = new window.AudioContext();
          this.scriptNode = this.audioCtx.createScriptProcessor(1024, 0, 2);
          this.scriptNode.onaudioprocess = this.onaudioprocess.bind(this);
          this.scriptNode.connect(this.audioCtx.destination);
        }
      }
      Speakers.prototype.stop = function () {
        if (this.scriptNode) {
          this.scriptNode.disconnect(this.audioCtx.destination);
          this.scriptNode.onaudioprocess = null;
          this.scriptNode = null;
        }
        if (this.audioCtx) {
          this.audioCtx.close().catch(handleError);
          this.audioCtx = null;
        }
      }
      Speakers.prototype.writeSample = function (left, right) {
        if (this.buffer.size() / 2 >= this.bufferSize) {
          // console.log(`Buffer overrun`);
          this.buffer.deqN(this.bufferSize / 2);
        }
        this.buffer.enq(left);
        this.buffer.enq(right);
      };
      Speakers.prototype.onaudioprocess = function (e) {
        var left = e.outputBuffer.getChannelData(0);
        var right = e.outputBuffer.getChannelData(1);
        var size = left.length;
        // We're going to buffer underrun. Attempt to fill the buffer.
        if (this.buffer.size() < size * 2 && this.onBufferUnderrun) {
          this.onBufferUnderrun(this.buffer.size(), size * 2);
        }
        try {
          var samples = this.buffer.deqN(size * 2);
        } catch (e) {
          // onBufferUnderrun failed to fill the buffer, so handle a real buffer
          // underrun
          // ignore empty buffers... assume audio has just stopped
          var bufferSize = this.buffer.size() / 2;
          if (bufferSize > 0) {
            // console.log(`Buffer underrun (needed ${size}, got ${bufferSize})`);
          }
          for (var j = 0; j < size; j++) {
            left[j] = 0;
            right[j] = 0;
          }
          return;
        }
        for (var i = 0; i < size; i++) {
          left[i] = samples[i * 2];
          right[i] = samples[i * 2 + 1];
        }
      };
      // var url = "ws://" + window.location.host + "/ws";
      // var ws = new WebSocket(url);

      // var screen = $("<canvas width='256' height='240'>");
      var screen = $("#canvas");
      // screen[0].style.height ="500px";
      screen[0].style.height = window.innerWidth + "px";
      var m = (window.innerWidth / 240 * 256 - window.innerWidth) / 2;
      var n = (window.innerHeight / 240 * 256 - window.innerHeight) / 2;
      // screen[0].style.transform="translate(-50%, -50%)";
      screen[0].style.transform = "rotate(90deg) translate(0px," + m + "px)";
      screen[0].style.left = 0;
      screen[0].style.right = 0;
      screen[0].style.top = 0;
      screen[0].style.bottom = 0;
      screen[0].style.margin = "auto auto";
      var context = screen[0].getContext('2d');
      var imageData = context.getImageData(0, 0, 256, 240);
      // $("#emulator").append(screen);
      this.player = 0;
      var frame = 0;
      var prevBuffer = new Array(256 * 240);
      function clearScreen() {
        context.fillStyle = "black";
        context.fillRect(0, 0, 256, 240);
        for (var i = 3; i < imageData.data.length - 3; i += 4) {
          imageData.data[i] = 0xFF;
        }
      }
      var speakers = new Speakers(
        function (actualSize, desiredSize) {
          if (this.props && this.props.paused) {
            return;
          }
        }
      );
      let lastTs = new Date().getTime();
      let sendDic = {};
      function createNes() {
        frame = 0;
        console.log('nes', nes)
        nes = new jsnes.NES({
          onFrame: function (buffer) {
            var data = imageData.data;
            var pixel, i, j;
            let c = 0;
            let transDic = {};
            if (frame > 0) {
              for (i = 0; i < 256 * 240; i++) {
                pixel = buffer[i];
                if (pixel != prevBuffer[i]) {
                  j = i * 4;
                  data[j] = pixel & 0xFF;
                  data[j + 1] = (pixel >> 8) & 0xFF;
                  data[j + 2] = (pixel >> 16) & 0xFF;
                  prevBuffer[i] = pixel;
                  c++
                  transDic[i] = pixel;
                }
              }
              // console.log(c)
              // console.log('transDic', JSON.stringify(transDic).length);
              let len = Object.keys(transDic).length;
              if (len) {
                let ts = new Date().getTime();
                if (ts - lastTs > 200) {
                  // for (i = 0; i < 256 * 240; i++) {
                  //   pixel = buffer[i];
                  //   if (pixel != sendDic[i]) {
                  //     sendDic[i] = pixel;
                  //   }
                  // }
                  // socket.emit("message", {
                  //   "transDic": transDic,
                  //   ts,
                  //   len
                  // });
                  lastTs = ts;
                }
              }
              context.putImageData(imageData, 0, 0);
            }
            // 重要！！！按钮回放功能
            // if (steps[frame]) {
            //   for (let i = 0; i < steps[frame].length; i++) {
            //     let dic = steps[frame][i];
            //     let key = KEYS[dic.keyCode];
            //     if(dic.type == 'up') {
            //       nes.buttonUp(key[0], key[1]);
            //     } else if (dic.type == 'down') {
            //       console.log(frame, dic.type, dic, key)
            //       nes.buttonDown(key[0], key[1]);
            //     }
            //   }
            // }
            frame += 1;
            // if (frame < 2500) {
            //   console.log(frame);
            //   nes.frame()
            // }
            // send at 30 fps
            // if (frame === 2) {
            //   // sendScreen();
            //   // drawData(data);
            //   frame = 0;
            // }
            // 测试自动存储
            // if (frame > 500 && frame % 100 == 0 && isNesIn) {
            //   console.log('save frame', nes);
            //   localStorage.nes = JSON.stringify(nes);
            // }
          },
          onAudioSample: (...arg) => {
            // console.log(arg);
            speakers.writeSample.bind(speakers)(...arg)
          },
          sampleRate: speakers.getSampleRate()
        });
      }
      function loadGames() {
        // $.getJSON('/gamelist', function (data) {
        var data = {
          games: ['lj65.nes']
        }
        var html = '';
        var len = data.games.length;
        for (var i = 0; i < len; i++) {
          html += '<option value="' + data.games[i] + '">' + data.games[i].replace(".nes", "") + '</option>';
        }
        $('#current-game').append(html);
        // });
      }
      function loadROM(url) {
        $.ajax({
          url: escape(url),
          xhr: function () {
            var xhr = $.ajaxSettings.xhr();
            xhr.overrideMimeType('text/plain; charset=x-user-defined');
            return xhr;
          },
          complete: function (xhr, status) {
            nes.loadROM(xhr.responseText);
            // nes.start();
          }
        });
      }
      function triggerKey(type, keyCode) {
        var e = jQuery.Event(type);
        e.which = keyCode;
        e.keyCode = keyCode;
        $(document).trigger(e);
      }
      function sendKey(type, keyCode) {
        ws.send(type + " " + keyCode);
      }
      function sendScreen(buffer) {
        var image = screen[0].toDataURL();
        ws.send("data " + image);
      }
      function drawData(data) {
        var img = new Image();
        img.src = data;
        context.drawImage(img, 0, 0);
      }
      function startPlaying(data) {
        window.player = parseInt(data, 10);
        if (window.player == 1) {
          newGame();
          $("#games-list").show();
          $("#message").text("You are Player 1");
        }
        if (window.player == 2) {
          $("#games-list").hide();
          $("#message").text("You are Player 2");
        }
      }
      function newGame() {
        var rom = document.getElementById("current-game").value;
        if (window.player == 1 && rom != "") {
          clearScreen();
          createNes();
          loadROM("/games?name=" + rom);
        }
      }
      window.newGame = newGame;
      function stopPlaying() {
        if (nes !== null) {
          nes.stop();
          nes = null;
        }
        clearScreen();
        window.player = 0;
        $("#message").text("Waiting for Player 2");
      }
      // ws.onmessage = function (msg) {
      //   var parts = msg.data.split(" ");
      //   var cmd = parts[0];
      //   var data = parts[1];

      //   if (cmd === "join") {
      //     startPlaying(data);
      //   }

      //   if (cmd === "part") {
      //     stopPlaying();
      //   }

      //   if (cmd === "keyup" || cmd === "keydown") {
      //     triggerKey(cmd, parseInt(data, 10));
      //   }

      //   if (cmd === "data") {
      //     drawData(data);
      //   }
      // };
      var keyMap = {
        88: 103,
        90: 105,
        17: 99,
        13: 97,
        38: 104,
        40: 98,
        37: 100,
        39: 102
      };

      const KEYS = {
        88: [1, jsnes.Controller.BUTTON_A, "X"], // X
        89: [1, jsnes.Controller.BUTTON_B, "Y"], // Y (Central European keyboard)
        90: [1, jsnes.Controller.BUTTON_B, "Z"], // Z
        17: [1, jsnes.Controller.BUTTON_SELECT, "Right Ctrl"], // Right Ctrl
        13: [1, jsnes.Controller.BUTTON_START, "Enter"], // Enter
        38: [1, jsnes.Controller.BUTTON_UP, "Up"], // Up
        40: [1, jsnes.Controller.BUTTON_DOWN, "Down"], // Down
        37: [1, jsnes.Controller.BUTTON_LEFT, "Left"], // Left
        39: [1, jsnes.Controller.BUTTON_RIGHT, "Right"], // Right
        103: [2, jsnes.Controller.BUTTON_A, "Num-7"], // Num-7
        105: [2, jsnes.Controller.BUTTON_B, "Num-9"], // Num-9
        99: [2, jsnes.Controller.BUTTON_SELECT, "Num-3"], // Num-3
        97: [2, jsnes.Controller.BUTTON_START, "Num-1"], // Num-1
        104: [2, jsnes.Controller.BUTTON_UP, "Num-8"], // Num-8
        98: [2, jsnes.Controller.BUTTON_DOWN, "Num-2"], // Num-2
        100: [2, jsnes.Controller.BUTTON_LEFT, "Num-4"], // Num-4
        102: [2, jsnes.Controller.BUTTON_RIGHT, "Num-6"] // Num-6
      };
      $(document).bind("contextmenu", function (evt) {
        evt.preventDefault();
      })
      // localStorage.step = '';

      $(document).bind("keydown", function (evt) {

        var key = KEYS[evt.keyCode];
        if (key) {
          nes.buttonDown(key[0], key[1]);
          console.log(key);
          socket.emit("message", {
            type: "down",
            key
          })
          steps[frame] = steps[frame] || [];
          steps[frame].push({
            type: "down",
            keyCode: evt.keyCode,
            frame
          })
          if (isIn) localStorage.steps = JSON.stringify(steps);
        }
        // nes.buttonDown(1, jsnes.Controller.BUTTON_A);
        // nes.keyboard.keyDown(evt);
        // if (window.player == 1) { nes.keyboard.keyDown(evt); }
        // if (window.player == 2 && keyMap[code]) { evt.preventDefault(); sendKey("keydown", keyMap[code]); }
      });

      $(document).bind("keyup", function (evt) {
        var key = KEYS[evt.keyCode];
        if (key) {
          nes.buttonUp(key[0], key[1]);
          socket.emit("message", {
            type: "up",
            key
          })
          steps[frame] = steps[frame] || [];
          steps[frame].push({
            type: "up",
            keyCode: evt.keyCode,
            frame
          })
          if (isIn) localStorage.steps = JSON.stringify(steps);
        }
        // if (window.player == 1) { nes.keyboard.keyUp(evt); }
        // if (window.player == 2 && keyMap[code]) { evt.preventDefault(); sendKey("keyup", keyMap[code]); }
      });
      // $('#btnall').bind("touchstart mousedown", function (evt) {
      //   console.log('touchstart');
      //   console.log(evt);
      //   // evt.preventDefault();
      //   // nes.buttonDown(KEYS[38][0], KEYS[38][1]);

      // });
      // $('#btnall').bind("touchmove mousemove", function (evt) {
      //   // console.log('touch');
      //   // console.log(evt);
      //   // evt.preventDefault();
      //   // nes.buttonDown(KEYS[38][0], KEYS[38][1]);

      // });
      // $('#btnall').bind("touchend mouseup", function (evt) {
      //   console.log('touchend');
      //   console.log(evt);
      //   // evt.preventDefault();
      //   // nes.buttonDown(KEYS[38][0], KEYS[38][1]);

      // });
      // 直接添加监听事件
      $('#btnup').bind("touchstart mousedown", function (evt) {
        // $('#btnup').bind("touchstart", function (evt) {

        evt.preventDefault();
        nes.buttonDown(KEYS[38][0], KEYS[38][1]);

        socket.emit("message", {
          type: "down",
          key: [KEYS[38][0], KEYS[38][1]]
        })
      });
      $('#btnup').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
        nes.buttonUp(KEYS[38][0], KEYS[38][1]);

        socket.emit("message", {
          type: "up",
          key: [KEYS[38][0], KEYS[38][1]]
        })
      });

      $(document).on('touchstart', function (e) {
        let touches = e.originalEvent.changedTouches;
        touchBtn(touches);
      })
      $(document).on('touchend', function (e) {
        let touches = e.originalEvent.changedTouches;
        console.log('touchend', touches)
        touchBtn(touches, 'touchend');
      })
      $(document).on('touchmove', function (e) {
        let touches = e.originalEvent.changedTouches;
        console.log('touchmove', touches)
        touchBtn(touches);
      })

      var touchDic = {
        'btnup': 0,
        'btnright': 0,
        'btn12': 0,
        'btn14': 0,
        'btndown': 0,
        'btnleft': 0,
        'btn23': 0,
        'btn34': 0,
        'btna': 0,
        'btnb': 0
      }
      function touchBtn(touches, type) {
        console.log(type)
        // ['btnup', 'btnright', 'btn12', 'btn14', 'btndown', 'btnleft', 'btn23', 'btn34', 'btna', 'btnb']
        for (let i = 0; i < touches.length; i++) {
          const tarTouch = touches[i];
          let x = tarTouch.clientX;
          let y = tarTouch.clientY;
          let dom = document.elementFromPoint(x, y);
          if (type == 'touchend') {
            touchDic[dom.id] = 0;
            processBtn(dom, touchDic[dom.id])
          } else {
            if (touchDic[dom.id] === 0) {
              touchDic[dom.id] = 2;
              processBtn(dom, touchDic[dom.id])
            }
            if (touchDic[dom.id] === 1) {
              touchDic[dom.id] = 2;
            }
          }
        }
        if (type == 'touchend') {
          return;
        }
        for (const i in touchDic) {
          if (type) {
            console.log(i, touchDic[i])
          }
          if (touchDic.hasOwnProperty(i)) {
            const tarTouch= touchDic[i];
            if (touchDic[i] === 1) {
              touchDic[i] = 0;
              processBtn({id:i}, 0)
            }
            if (touchDic[i] === 2) {
              touchDic[i] = 1;
            }
          }
        }
        console.log(touchDic);
      }
      function processBtn(dom, isDown) {
        console.log(arguments);
        let tarFunc;
        if (isDown) {
          tarFunc = nes.buttonDown;
        } else {
          tarFunc = nes.buttonUp;
        }
        if (dom.id == 'btnup') {
          tarFunc(KEYS[38][0], KEYS[38][1]);
        }
        if (dom.id == 'btnright') {
          tarFunc(KEYS[39][0], KEYS[39][1]);
        }
        if (dom.id == 'btn12') {
          tarFunc(KEYS[38][0], KEYS[38][1]);
          tarFunc(KEYS[39][0], KEYS[39][1]);
        }
        if (dom.id == 'btn14') {
          tarFunc(KEYS[38][0], KEYS[38][1]);
          tarFunc(KEYS[37][0], KEYS[37][1]);
        }
        if (dom.id == 'btndown') {
          tarFunc(KEYS[40][0], KEYS[40][1]);
        }
        if (dom.id == 'btnleft') {
          tarFunc(KEYS[37][0], KEYS[37][1]);
        }
        if (dom.id == 'btn23') {
          tarFunc(KEYS[39][0], KEYS[39][1]);
          tarFunc(KEYS[40][0], KEYS[40][1]);
        }
        if (dom.id == 'btn34') {
          tarFunc(KEYS[40][0], KEYS[40][1]);
          tarFunc(KEYS[37][0], KEYS[37][1]);
        }
        if (dom.id == 'btna') {
          tarFunc(KEYS[88][0], KEYS[88][1]);
        }
        if (dom.id == 'btnb') {
          tarFunc(KEYS[89][0], KEYS[89][1]);
        }
      }
      // $('#btnright').bind("touchstart mousedown", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonDown(KEYS[39][0], KEYS[39][1]);
      //   socket.emit("message", {
      //     type: "down",
      //     key: [KEYS[39][0], KEYS[39][1]]
      //   })
      // });
      // $('#btnright').bind("touchend mouseup", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonUp(KEYS[39][0], KEYS[39][1]);
      //   socket.emit("message", {
      //     type: "up",
      //     key: [KEYS[39][0], KEYS[39][1]]
      //   })
      // });

      // $('#btn12').bind("touchstart mousedown", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonDown(KEYS[38][0], KEYS[38][1]);
      //   nes.buttonDown(KEYS[39][0], KEYS[39][1]);
      //   socket.emit("message", {
      //     type: "down",
      //     key: [KEYS[39][0], KEYS[39][1]]
      //   })
      // });
      // $('#btn12').bind("touchend mouseup", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonUp(KEYS[38][0], KEYS[38][1]);
      //   nes.buttonUp(KEYS[39][0], KEYS[39][1]);
      //   socket.emit("message", {
      //     type: "up",
      //     key: [KEYS[39][0], KEYS[39][1]]
      //   })
      // });
      // $('#btn14').bind("touchstart mousedown", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonDown(KEYS[38][0], KEYS[38][1]);
      //   nes.buttonDown(KEYS[37][0], KEYS[37][1]);
      //   socket.emit("message", {
      //     type: "down",
      //     key: [KEYS[37][0], KEYS[37][1]]
      //   })
      // });
      // $('#btn14').bind("touchend mouseup", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonUp(KEYS[38][0], KEYS[38][1]);
      //   nes.buttonUp(KEYS[37][0], KEYS[37][1]);
      //   socket.emit("message", {
      //     type: "up",
      //     key: [KEYS[37][0], KEYS[37][1]]
      //   })
      // });


      // $('#btndown').bind("touchstart mousedown", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonDown(KEYS[40][0], KEYS[40][1]);
      //   socket.emit("message", {
      //     type: "down",
      //     key: [KEYS[40][0], KEYS[40][1]]
      //   })
      // });
      // $('#btndown').bind("touchend mouseup", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonUp(KEYS[40][0], KEYS[40][1]);
      //   socket.emit("message", {
      //     type: "up",
      //     key: [KEYS[40][0], KEYS[40][1]]
      //   })
      // });

      // $('#btn23').bind("touchstart mousedown", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonDown(KEYS[39][0], KEYS[39][1]);
      //   nes.buttonDown(KEYS[40][0], KEYS[40][1]);
      //   socket.emit("message", {
      //     type: "down",
      //     key: [KEYS[40][0], KEYS[40][1]]
      //   })
      // });
      // $('#btn23').bind("touchend mouseup", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonUp(KEYS[39][0], KEYS[39][1]);
      //   nes.buttonUp(KEYS[40][0], KEYS[40][1]);
      //   socket.emit("message", {
      //     type: "up",
      //     key: [KEYS[40][0], KEYS[40][1]]
      //   })
      // });

      // $('#btnleft').bind("touchstart mousedown", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonDown(KEYS[37][0], KEYS[37][1]);
      //   socket.emit("message", {
      //     type: "down",
      //     key: [KEYS[37][0], KEYS[37][1]]
      //   })
      // });
      // $('#btnleft').bind("touchend mouseup", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonUp(KEYS[37][0], KEYS[37][1]);
      //   socket.emit("message", {
      //     type: "up",
      //     key: [KEYS[37][0], KEYS[37][1]]
      //   })
      // });

      // $('#btn34').bind("touchstart mousedown", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonDown(KEYS[40][0], KEYS[40][1]);
      //   nes.buttonDown(KEYS[37][0], KEYS[37][1]);
      //   socket.emit("message", {
      //     type: "down",
      //     key: [KEYS[37][0], KEYS[37][1]]
      //   })
      // });
      // $('#btn34').bind("touchend mouseup", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonUp(KEYS[40][0], KEYS[40][1]);
      //   nes.buttonUp(KEYS[37][0], KEYS[37][1]);
      //   socket.emit("up", {
      //     type: "up",
      //     key: [KEYS[37][0], KEYS[37][1]]
      //   })
      // });
      $('#btnsave').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        localStorage.nes = JSON.stringify(nes);
      });
      $('#btnsave').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });
      $('#btnload').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        loadSavedData();
      });
      $('#btnload').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });
      $('#btnspeed').bind("touchstart mousedown", function (evt) {
        if (frameSpeed == 1) frameSpeed = 5;
        else frameSpeed = 1;
        evt.preventDefault();
      });
      $('#btnspeed').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });

      $('#btnselect').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        nes.buttonDown(KEYS[17][0], KEYS[17][1]);
        socket.emit("message", {
          type: "down",
          key: [KEYS[17][0], KEYS[17][1]]
        })
        if (speakers.audioCtx)
          speakers.audioCtx.resume();
      });
      $('#btnselect').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
        nes.buttonUp(KEYS[17][0], KEYS[17][1]);
        socket.emit("message", {
          type: "up",
          key: [KEYS[17][0], KEYS[17][1]]
        })
      });
      $('#btnstart').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        nes.buttonDown(KEYS[13][0], KEYS[13][1]);
        socket.emit("message", {
          type: "down",
          key: [KEYS[13][0], KEYS[13][1]]
        })
        if (speakers.audioCtx)
          speakers.audioCtx.resume();
      });
      $('#btnstart').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
        nes.buttonUp(KEYS[13][0], KEYS[13][1]);
        socket.emit("message", {
          type: "up",
          key: [KEYS[13][0], KEYS[13][1]]
        })
      });
      // $('#btna').bind("touchstart mousedown", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonDown(KEYS[88][0], KEYS[88][1]);
      //   socket.emit("message", {
      //     type: "down",
      //     key: [KEYS[88][0], KEYS[88][1]]
      //   })
      // });
      // $('#btna').bind("touchend mouseup", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonUp(KEYS[88][0], KEYS[88][1]);
      //   socket.emit("message", {
      //     type: "up",
      //     key: [KEYS[88][0], KEYS[88][1]]
      //   })
      // });
      // $('#btnb').bind("touchstart mousedown", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonDown(KEYS[89][0], KEYS[89][1]);
      //   socket.emit("message", {
      //     type: "down",
      //     key: [KEYS[89][0], KEYS[89][1]]
      //   })
      // });
      // $('#btnb').bind("touchend mouseup", function (evt) {
      //   evt.preventDefault();
      //   nes.buttonUp(KEYS[89][0], KEYS[89][1]);
      //   socket.emit("message", {
      //     type: "up",
      //     key: [KEYS[89][0], KEYS[89][1]]
      //   })
      // });
      $('#config-btn').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        nes.buttonDown(KEYS[89][0], KEYS[89][1]);
        isConfigShow = !isConfigShow;
        if (isConfigShow) {
          $('#game-list-box').show();
          $('#btnsave').hide();
          $('#btnload').show();
        } else {
          $('#game-list-box').hide();
          $('#btnsave').show();
          $('#btnload').hide();
        }
      });

      clearScreen();
      createNes();

      function loadBinary(path, callback, handleProgress) {
        var req = new XMLHttpRequest();
        req.open("GET", path);
        req.overrideMimeType("text/plain; charset=x-user-defined");
        req.onload = function () {
          if (this.status === 200) {
            if (req.responseText.match(/^<!doctype html>/i)) {
              // Got HTML back, so it is probably falling back to index.html due to 404
              return callback(new Error("Page not found"));
            }

            callback(null, this.responseText);
          } else if (this.status === 0) {
            // Aborted, so ignore error
          } else {
            callback(new Error(req.statusText));
          }
        };
        req.onerror = function () {
          callback(new Error(req.statusText));
        };
        req.onprogress = handleProgress;
        req.send();
        return req;
      }

      loadBinary(romurl, (err, data) => {
        if (err) {
          // this.setState({ error: `Error loading ROM: ${err.message}` });
          console.log(err);
        } else {
          nes.loadROM(data);

          interval = setInterval(function () {
            nes.frame();
            if (frameSpeed == 5) {
              nes.frame();
              nes.frame();
            }
          }, 16);
          // 重要！！！ 这里可以证明 只要把整个 nes存下来 就可以 做到存档
          // setTimeout(()=>{
          //   nes2 = nes;
          //   createNes();
          //   nes.loadROM(data);
          // }, 15000)
          // setTimeout(()=>{
          //   nes = nes2;
          // }, 20000)
          // console.log("nes2['cpu']['mem']", nes2['cpu']['mem'])
          // nes['cpu']['mem'] = nes2['cpu']['mem'];
          speakers.start();
          let c = 0;
          /// 哇塞塞！！！好像成功了耶
          // for (const key in nes2) {
          //   c++
          //   if (c==4) {
          //     console.log('key', key);
          //     const element = nes2[key];
          //     let d = 0;
          //     for (const key2 in element) {
          //       // if (element.hasOwnProperty(key2)) {
          //       //   const element2 = element[key2];
          //       //   nes[key] = nes[key] || nes2[key];
          //       //   nes[key][key2] = element2;
          //       // }
          //       console.log(key2);
          //     }
          //     continue;
          //   }
          //   if (nes2.hasOwnProperty(key) && c != 4) {
          //     console.log(key);
          //     const element = nes2[key];
          //     for (const key2 in element) {
          //       if (element.hasOwnProperty(key2)) {
          //         const element2 = element[key2];
          //         nes[key] = nes[key] || nes2[key];
          //         nes[key][key2] = element2;
          //       }
          //     }
          //   }
          // }
          // 不自动读档，在config里面，去点击读档
          // setB2A(nes, nes2);
          // this.handleLoaded(data);
        }
      }, null)

      window.onunload = function () {
        if (interval)
          clearInterval(interval);
        speakers.stop();
        console.log('onunload');
      };
    });
    function doSth(key) {

    }
  </script>
  <!-- <script src="http://192.168.1.47:3000/socket.io/socket.io.js"></script> -->
  <script>
    // 暂时关闭联机功能
    let socket = {
      emit: function emit(...args) {
        console.log('emit', args);
      },
    }
    // socket = io.connect('ws://192.168.1.47:3000');
    // socket.emit("message", {
    //   "name": navigator.userAgent, "msg": "hello world"
    // });
    // socket.on("message", function (obj) {
    //   // console.log(obj);
    // });
  </script>
</body>

</html>
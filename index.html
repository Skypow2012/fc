<!DOCTYPE html>
<html lang="en" style="position: fixed;width: 100vw;height: 100vh;left: 0;top: 0;">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport" />
  <!-- <script src="https://www.norchant.com/js/vconsole.min.js"></script> -->
  <title>红白机模拟器</title>
  <!-- <script type="text/javascript" src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script> -->
  <script type="text/javascript" src="./js/jsnes.min.js"></script>
  <!-- <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.0.min.js"></script> -->
  <script type="text/javascript" src="./js/jquery-3.4.0.min.js"></script>
  <style>
    body {
      overflow: hidden;
      background-color: black;
    }

    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    #emulator {
      margin: 0 auto;
      width: 100%;
    }

    #canvas {
      position: fixed;
      /* width: 100%; */
      /* transform: rotate(90deg); */
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: 0 auto;
    }

    #canvasTips {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: 0 auto;
    }

    #canvasTips>span {
      display: inline-block;
      position: fixed;
      color: white;
      width: 200px;
      text-align: center;
      height: 20px;
      font-size: 20px;
      left: calc(50vw - 100px);
      top: calc(50vh - 10px);
      transform: rotateZ(90deg);
    }

    #message {
      font-family: sans-serif;
      padding: 30px;
      font-weight: 500;
    }

    #keys {
      font-size: 14px;
      font-family: sans-serif;
      padding-bottom: 15px;
    }

    #games-list {
      padding-bottom: 15px;
    }

    #game-list-box {
      display: none;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: -140px;
      width: 50vw;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      opacity: .8;
      transform: rotateZ(90deg);
    }

    #game-list {
      margin-top: 0;
      height: 60vw;
      overflow: auto;
      background-color: black;
    }

    #game-list-box p {
      margin: 0;
      height: 3rem;
      font-size: 1.5rem;
      line-height: 3rem;
      color: #ffffff;
      border: 1px solid #ffffff;
    }

    #fps,
    #f {
      display: none;
      opacity: .5;
    }

    #time {
      position: absolute;
      display: none;
      text-align: right;
      width: 65px;
      font-size: 13px;
      color: white;
      transform: rotateZ(90deg);
      right: calc(4vw - 27px);
      bottom: 65px;
    }
  </style>
  <script>
    // 简易追踪马里奥算法
    HTMLElement.prototype.getPixelColor = function (x, y) {
      var thisContext = this.getContext("2d");
      var imageData = thisContext.getImageData(x, y, 1, 1);
      var pixel = imageData.data;
      var r = pixel[0];
      var g = pixel[1];
      var b = pixel[2];
      var a = pixel[3] / 255
      a = Math.round(a * 100) / 100;
      var rHex = r.toString(16);
      r < 16 && (rHex = "0" + rHex);
      var gHex = g.toString(16);
      g < 16 && (gHex = "0" + gHex);
      var bHex = b.toString(16);
      b < 16 && (bHex = "0" + bHex);
      var rgbaColor = "rgba(" + r + "," + g + "," + b + "," + a + ")";
      var rgbColor = "rgb(" + r + "," + g + "," + b + ")";
      var hexColor = "#" + rHex + gHex + bHex;
      return {
        rgba: rgbaColor,
        rgb: rgbColor,
        hex: hexColor,
        r: r,
        g: g,
        b: b,
        a: a
      };
    }
    // let ctx = canvas.getContext('2d');
    // window.ctx = ctx;
    // ctx.fillStyle = "red";
    // ctx.lineWidth = 4;
    let x = 0;
    let y = 0;
    let img;
    let img3;
    let tX = 0;
    let tY = 0;

    function myFunction(ev) {
      console.log('123123')
      // canvas.removeEventListener('click', myFunction);
      console.log(ev);
      // return;
      window.x = ev.offsetX;
      window.y = ev.offsetY;
      window.w = ev.target.offsetWidth;
      window.h = ev.target.offsetHeight;
      tX = x * 256 / w;
      tY = y * 240 / h;
      window.sTs = Date.now();
      console.log('src', tX, tY)
      window.tX2 = 0;
      window.tY2 = 0;
      if (!img) {
        console.log('change img')
        // img = ctx.getImageData(tX, tY, 12, 16);
        img = JSON.parse(JSON.stringify(context.getImageData(tX, tY, 12, 16)));
        console.log(context.getImageData(tX, tY, 12, 16), img);
        img.width = 12;
        img.height = 16;
      }
      window.catchDic = window.catchDic || {}


      // setInterval(goPikachu, 50) // 这里注释了，放到了onframe里面
    }

    function goPikachu() {
      if (!window.w) {
        return;
      }
      let maxEC = 0;
      let isFind = false;
      for (let k = 0; k < w * h; k++) {
        if ((k % w) > 100) {
          continue;
        }
        if ((k % w) < tX - 20 || (k % w) > tX + 20) {
          continue;
        }
        if ((k / w | 0) < tY - 30 || (k / w | 0) > tY + 30) {
          continue;
        }
        let img2 = context.getImageData(k % w, k / w | 0, 12, 16);
        let eC = 0; // 颜色相同统计
        for (let j = 0; j < img.height; j++) {
          for (let i = 0; i < img.width; i++) {
            let idx = (j * img.width + i) * 4;
            let r = img.data[idx];
            let g = img.data[idx + 1];
            let b = img.data[idx + 2];
            let a = img.data[idx + 3];

            let r2 = img2.data[idx];
            let g2 = img2.data[idx + 1];
            let b2 = img2.data[idx + 2];
            let a2 = img2.data[idx + 3];

            if (img3) {
              let r3 = img3.data[idx];
              let g3 = img3.data[idx + 1];
              let b3 = img3.data[idx + 2];
              let a3 = img3.data[idx + 3];
              if (r3 == r2 && g3 == g2 && b3 == b2) {
                eC = eC + 0.05;
                // console.log(r,g,b);
                // window.catchDic[`${r},${g},${b}`]=window.catchDic[`${r},${g},${b}`] || 0;
                // window.catchDic[`${r},${g},${b}`]+=1;
              }
            }
            if (r == 0 && g == 171 && b == 0) {
              continue;
            }
            if (r == 129 && g == 121 && b == 255) {
              continue;
            }
            if (r == 117 && g == 227 && b == 0) {
              continue;
            }
            if (r == 188 && g == 25 && b == 0) {
              continue;
            }
            if (r == 177 && g == 84 && b == 0) {
              continue;
            }
            if (r == 0 && g == 0 && b == 0) {
              continue;
            }
            if (r == g && g == b) {
              continue;
            }
            if (r == r2 && g == g2 && b == b2) {
              eC++;
              // console.log(r,g,b);
              window.catchDic[`${r},${g},${b}`] = window.catchDic[`${r},${g},${b}`] || 0;
              window.catchDic[`${r},${g},${b}`] += 1;
            }
          }
        }
        eC -= Math.abs(k % w - tX);
        // eC -= 1*Math.abs(k / w|0 - tY);
        if (eC > 10 && eC > maxEC) {
          maxEC = eC;
          // console.log(eC, k, k % w, k / w | 0, img, img2)
          tX2 = k % w;
          tY2 = k / w | 0;
          // console.log('!!!!!!', k / w | 0, y, tY)
          isFind = true;
          img3 = img2;
        }
        // if (k % 2000 == 0) {
        //   console.log(Date.now() - sTs, k);
        // }
      }
      console.log(tX2, tY2, isFind)
      if (tX2 && tY2 && isFind) {
        // console.log('tar', w * h, tX2, tY2)
        clearInterval(window.shadowInter);
        window.shadowInter = setInterval(() => {
          // ctx.fillRect(tX2, tY2, 12, 16);
          context.strokeRect(tX2, tY2, 12, 16);
        })
        tX = tX2;
        tY = tY2;
      }

      // console.log(img)
      // checkImg.src = img;
      // checkImg.onready = function () {
      //   console.log(img)
      //   check.getC
      //   check.getContext('2d').drawImage(img, 0, 0)
      // }
    }
  </script>
</head>

<body>
  <input id="fps" disabled />
  <input id="f" disabled />
  <span id="time">Ready</span>
  <canvas id="canvas" width='256px' height='240px'></canvas>
  <!-- <script>
    canvas.addEventListener('click', myFunction); // 关闭监听 画框
  </script> -->
  <div id="canvasTips"></div>
  <img id="checkImg"></img>
  <canvas id="check" width='12px' height='16px'></canvas>
  <!-- <div id="btnall"
    style="opacity:0.5;width:45vw;height:45vw;background-size:45vw 45vw;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:5vw;top:5vw;transform: rotate(90deg);">
  </div> -->
  <div class="btn" id="changePlayer"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/player1.png');background-repeat:no-repeat;position:fixed;right:calc(2vw + 50px);top:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btnup">
  </div>
  <div class="btn" id="btnright"
    style="opacity:0.5;width:15vw;height:20vw;background-size:15vw 15vw;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:20vw;top:30vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btn12"
    style="width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:35vw;top:35vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btndown">
  </div>
  <div class="btn" id="btn23"
    style="width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:5vw;top:35vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btnleft"
    style="opacity:0.5;width:15vw;height:20vw;background-size:15vw 15vw;background-image:url('./img/btn.png');background-repeat:no-repeat;position:fixed;left:20vw;top:5vw;">
  </div>
  <div class="btn" id="btn34"
    style="width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:5vw;top:5vw;transform: rotate(180deg);">
  </div>
  <div class="btn" id="btn14"
    style="width:15vw;height:15vw;background-size:15vw 15vw;background-image:url('./img/empty.png');background-repeat:no-repeat;position:fixed;left:35vw;top:5vw;transform: rotate(180deg);">
  </div>
  <div class="btn top-btn" id="btnsave"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/btnsave.png');background-repeat:no-repeat;position:fixed;right:2vw;top:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn top-btn" id="btnload"
    style="display:none;opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/btnload.png');background-repeat:no-repeat;position:fixed;right:2vw;top:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn top-btn" id="btnspeed"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/btnspeed.png');background-repeat:no-repeat;position:fixed;right:2vw;top:35vw;transform: rotate(90deg);">
  </div>
  <div class="btn top-btn" id="btnselect"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/btnselect.png');background-repeat:no-repeat;position:fixed;right:2vw;bottom:35vw;transform: rotate(90deg);">
  </div>
  <div class="btn top-btn" id="btnstart"
    style="opacity:0.5;width:20vw;height:8.88vw;background-size:20vw 8.88vw;background-image:url('./img/btnstart.png');background-repeat:no-repeat;position:fixed;right:2vw;bottom:10vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btnb"
    style="opacity:0.5;width:22vw;height:22vw;background-size:22vw 22vw;background-image:url('./img/btnb.png');background-repeat:no-repeat;position:fixed;left:5vw;bottom:26vw;transform: rotate(90deg);">
  </div>
  <div class="btn" id="btna"
    style="opacity:0.5;width:22vw;height:22vw;background-size:22vw 22vw;background-image:url('./img/btna.png');background-repeat:no-repeat;position:fixed;left:5vw;bottom:5vw;transform: rotate(90deg);">
  </div>
  <div class="config-btn top-btn" id="config-btn"
    style="opacity: 0.5;width: 6vh;height: 6vh;background-size: 100% 100%;background-image: url(./img/config.png);background-repeat: no-repeat;position: fixed;top: 47vh;right: -3vw;transform: rotate(90deg);">
  </div>
  <div class="game-list-box" id="game-list-box">
    <div class="game-list" id="game-list">
      <p
        onclick="localStorage.romurl = './rom/Chip To Dale No Daisakusen 2 (J).nes';window.location.href = window.location.href;">
        松鼠大作战</p>
      <p onclick="localStorage.romurl = './rom/mario.nes';window.location.href = window.location.href;">马里奥</p>
      <p onclick="localStorage.romurl = './rom/希特勒复活.nes';window.location.href = window.location.href;">希特勒复活</p>
      <p onclick="localStorage.romurl = './rom/c31.nes';window.location.href = window.location.href;">中国象棋</p>
      <p onclick="localStorage.romurl = './rom/Double Dragon (U).nes';window.location.href = window.location.href;">
        双截龙1(美版)</p>
      <p onclick="localStorage.romurl = './rom/Yie Ar Kung-Fu (J).nes';window.location.href = window.location.href;">功夫
      </p>
      <p onclick="localStorage.romurl = './rom/iceclimb.nes';window.location.href = window.location.href;">雪人兄弟</p>
      <p
        onclick="localStorage.romurl = './rom/Dragonlance - Dragons of Flame (J).nes';window.location.href = window.location.href;">
        龙之矛-龙的火焰</p>
      <p onclick="localStorage.romurl = './rom/vs dr mario.nes';window.location.href = window.location.href;">马里奥医生</p>
      <p onclick="localStorage.romurl = './rom/马戏团.nes';window.location.href = window.location.href;">马戏团(中文)</p>
      <p onclick="localStorage.romurl = './rom/Makaimura (J).nes';window.location.href = window.location.href;">魔界村</p>
      <p onclick="localStorage.romurl = './rom/Battle City (J).nes';window.location.href = window.location.href;">坦克大战
      </p>
      <p onclick="localStorage.romurl = './rom/CONTRA.NES';window.location.href = window.location.href;">魂斗罗</p>
      <p onclick="localStorage.romurl = './rom/NINJAGA3.NES';window.location.href = window.location.href;">忍者龙剑传3</p>
      <p onclick="localStorage.romurl = './rom/zhonghuadaxian.nes';window.location.href = window.location.href;">中华大仙
      </p>
      <p
        onclick="localStorage.romurl = './rom/Chuugoku Senseijutsu (Japan).nes';window.location.href = window.location.href;">
        中国占星术</p>
      <p onclick="localStorage.romurl = './rom/BOMBMAN.NES';window.location.href = window.location.href;">炸弹人</p>
      <p onclick="localStorage.romurl = './rom/Bomberman 2 (U).nes';window.location.href = window.location.href;">炸弹人2
      </p>
      <p onclick="localStorage.romurl = './rom/smbc.nes';window.location.href = window.location.href;">马里奥双人版</p>
      <p onclick="localStorage.romurl = './rom/X-MEN.NES';window.location.href = window.location.href;">X-MEN</p>
      <p onclick="localStorage.romurl = './rom/kdxfzwb.nes';window.location.href = window.location.href;">快打旋风中文版</p>
      <p onclick="localStorage.romurl = './rom/ZELDA.NES';window.location.href = window.location.href;">ZELDA</p>
      <p onclick="localStorage.romurl = './rom/ZELDA2.NES';window.location.href = window.location.href;">ZELDA2</p>


      <!-- This ROM uses a mapper not supported by JSNES: Namcot 106 chip(19) -->
      <!-- <p onclick="localStorage.romurl = './rom/Sangokushi 2.nes';window.location.href = window.location.href;">三国志2霸王的大陆</p> -->

    </div>

  </div>
  <!-- 排名部分代码 -->
  <style>
    .rankArea {
      display: none;
      font-size: 0;
      background-color: #111111;
      position: fixed;
      width: 200px;
      height: 80vw;
      max-height: 336px;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      margin: auto;
      text-align: center;
      padding-top: 10px;
      transform: rotateZ(90deg);
      border-radius: 3px;
      box-shadow: 0px 0px 20px #11111188;
    }

    .rankCloseBtn {
      position: absolute;
      width: 31px;
      height: 31px;
      bottom: 15px;
      left: -100px;
      right: 0;
      margin: auto;
      font-size: 30px;
    }

    .rankChallengeBtn {
      position: absolute;
      width: 30px;
      height: 30px;
      bottom: 15px;
      left: 0;
      right: -100px;
      margin: auto;
      font-size: 30px;
    }

    .rankCloseBtn:active,
    .rankChallengeBtn:active {
      opacity: .6;
    }

    .rankBox {
      height: calc(100% - 30px - 60px);
      overflow: auto;
    }

    .rankTitle {
      font-size: 20px;
      color: #fffeff;
      margin-bottom: 5px;
    }

    .rankP {
      padding-left: 2px;
      background-color: #b15400;
      display: inline-block;
      width: 90%;
      height: 25px;
      box-sizing: border-box;
      border: 1px solid #e6a886;
      margin: 1px 0;
      text-align: left;
    }

    .rankP:active {
      opacity: .6;
    }

    .rankIdx,
    .rankName,
    .rankUsetime {
      display: inline-block;
      overflow: hidden;
      color: #ffd1c7;
      line-height: 20px;
    }

    .rankIdx {
      width: 30px;
      color: #f7b400;
      font-size: 20px;
    }

    .rankName {
      width: 85px;
      font-size: 16px;
    }

    .rankUsetime {
      width: 55px;
      font-size: 16px;
    }
  </style>
  <div id="rankArea" class="rankArea">
    <div id="rankTitle" class="rankTitle">TEKII 09.05 RANK</div>
    <div id="rankBox" class="rankBox">
      <div class="rankP">
        <span class="rankIdx">01</span>
        <span class="rankName">Maxmon</span>
        <span class="rankUsetime">24.95</span>
      </div>
      <div class="rankP">
        <span class="rankIdx">02</span>
        <span class="rankName">Yahaha</span>
        <span class="rankUsetime">27.95</span>
      </div>
    </div>
    <!-- <svg t="1599302195443" onclick="hideRank()" class="rankCloseBtn" viewBox="0 0 1024 1024" version="1.1"
      xmlns="http://www.w3.org/2000/svg" p-id="1383" width="90" height="90">
      <path
        d="M511.968 376.224 796.096 92.096C833.536 54.624 894.4 54.624 931.84 92.096 969.312 129.568 969.312 190.4 931.84 227.872L647.744 512 931.84 796.096C969.312 833.568 969.312 894.4 931.84 931.872 894.4 969.344 833.536 969.344 796.096 931.872L511.968 647.744 227.84 931.872C190.4 969.344 129.536 969.344 92.096 931.872 54.624 894.4 54.624 833.568 92.096 796.096L376.224 512 92.096 227.872C54.624 190.4 54.624 129.568 92.096 92.096 129.536 54.624 190.4 54.624 227.84 92.096L511.968 376.224Z"
        p-id="1384" fill="#ffffff"></path>
    </svg> -->
    <svg t="1599320359254" onclick="hideRank()" class="rankCloseBtn" viewBox="0 0 1024 1024" version="1.1"
      xmlns="http://www.w3.org/2000/svg" p-id="2480" width="90" height="90">
      <path
        d="M512.001 15.678C237.414 15.678 14.82 238.273 14.82 512.86S237.414 1010.04 512 1010.04s497.18-222.593 497.18-497.18S786.589 15.678 512.002 15.678z m213.211 645.937c17.798 17.803 17.798 46.657 0 64.456-17.798 17.797-46.658 17.797-64.456 0L512.001 577.315 363.241 726.07c-17.799 17.797-46.652 17.797-64.45 0-17.804-17.799-17.804-46.653 0-64.456L447.545 512.86 298.79 364.104c-17.803-17.798-17.803-46.657 0-64.455 17.799-17.798 46.652-17.798 64.45 0l148.761 148.755 148.755-148.755c17.798-17.798 46.658-17.798 64.456 0 17.798 17.798 17.798 46.657 0 64.455L576.456 512.86l148.756 148.755z m0 0"
        fill="#bc1900" p-id="2481"></path>
    </svg>
    <svg t="1599318965085" onclick="startChallenge()" class="rankChallengeBtn" viewBox="0 0 1024 1024" version="1.1"
      xmlns="http://www.w3.org/2000/svg" p-id="16010" width="90" height="90">
      <path
        d="M512 1024C229.239467 1024 0 794.760533 0 512S229.239467 0 512 0 1024 229.239467 1024 512 794.760533 1024 512 1024z m326.200889-467.626667c-20.707556-178.084978-57.344-305.743644-173.6704-305.743644-58.936889 0-89.201778 59.892622-141.789867 64.625778-54.158222-4.733156-82.852978-64.625778-141.812622-64.625778-116.303644 0-152.940089 127.658667-172.077511 304.173511-11.150222 94.549333-1.592889 173.351822 57.366755 173.351822 82.830222 0 86.038756-74.069333 144.9984-108.7488 22.300444-11.036444 71.68-15.746844 113.095112-17.339733 41.437867 1.592889 90.840178 6.303289 113.140622 17.339733 58.936889 34.679467 62.122667 108.7488 144.9984 108.7488 57.344 1.592889 65.308444-77.232356 55.751111-171.781689z"
        p-id="16011" fill="#f7b400"></path>
      <path
        d="M382.520889 540.626489c-46.193778 0-82.830222-37.842489-82.830222-81.965511 0-44.123022 36.636444-81.942756 82.830222-81.942756 46.193778 0 82.852978 36.2496 82.852978 81.942756 0 45.715911-38.229333 81.965511-82.830223 81.965511z m-47.786667-81.965511c0 12.606578 4.778667 23.643022 14.336 33.109333 7.964444 7.873422 20.707556 14.176711 33.450667 14.176711 12.743111 0 23.893333-4.733156 33.450667-14.176711 7.964444-7.896178 14.336-20.48 14.336-33.109333 0-12.606578-4.778667-23.643022-14.336-33.086578-7.964444-7.873422-20.707556-14.199467-33.450667-14.199467-12.743111 0-23.893333 4.733156-33.450667 14.199467-9.557333 7.873422-14.336 20.48-14.336 33.086578zM753.755022 474.430578h-65.308444v64.625778h-31.857778v-64.625778h-65.353956v-31.516445h65.3312v-63.032889h31.857778v63.032889h65.3312z"
        p-id="16012" fill="#f7b400"></path>
    </svg>
  </div>
  <script>
    function hideRank() {
      document.getElementById('rankArea').style.display = 'none';
    }

    function startChallenge() {
      hideRank();
      window.isChallenge = true;
    }

    function getRank() {
      $.ajax({
        url: '/market/fc/getWin',
        complete: function (xhr, status) {
          let winList = xhr.responseJSON.info;
          window.winList = winList;
          let rankBox = document.getElementById('rankBox');
          console.log(winList)
          rankBox.innerHTML = '';
          for (let i = 0; i < winList.length; i++) {
            let rankP = document.createElement('div');
            rankP.className = 'rankP';
            rankP.onclick = function () {
              showZZDJS(i);
            }
            rankP.innerHTML = `<span class="rankIdx">${('00' + (i + 1)).substr(-2)}</span>
              <span class="rankName">${winList[i].name}</span>
              <span class="rankUsetime">${Number(Number(winList[i].usetime/1000).toFixed(2))}</span>`
            rankBox.appendChild(rankP);
          }
          document.getElementById('rankArea').style.display = 'block';
        }
      });
    }
    if (localStorage.romurl == './rom/mario.nes') {
      getRank()
    }

    function restartGame() {
      window.nes.reloadROM();
      window.frame = 0;
      window.clearInterval(window.nesInterval);
      window.nesInterval = setInterval(function () {
        goF(nes);
        if (frameSpeed == 5) {
          goF(nes);
          goF(nes);
        }
      }, 16);
    }

    function showZZDJS(id) {
      window.arr = JSON.parse(window.winList[id].step);
      window.isZZDJS = true;
      window.isChallenge = true;
      restartGame();
      hideRank();
    }
  </script>
  <style>
    .top-btn:active {
      opacity: 0.2 !important;
    }

    .btn.active {
      opacity: 0.2 !important;
    }

    #btnup {
      opacity: 0.5;
      width: 15vw;
      height: 20vw;
      background-size: 15vw 15vw;
      background-image: url(./img/btn.png);
      background-repeat: no-repeat;
      position: fixed;
      left: 37.5vw;
      top: 17.5vw;
      transform: rotate(90deg);
      background-position: bottom;
    }

    #btndown {
      opacity: 0.5;
      width: 15vw;
      height: 20vw;
      background-size: 15vw 15vw;
      background-image: url(./img/btn.png);
      background-repeat: no-repeat;
      position: fixed;
      left: 2.5vw;
      top: 17.5vw;
      transform: rotate(270deg);
      background-position: bottom;
    }
  </style>
  <script>
    window.playerId = window.location.href.indexOf('p2') > -1 ? 2 : 1;
    let f = document.getElementById('f')
    window.cId = Math.random().toString().substr(2, 5);
    let startFrame = 0;

    function goF(nes) {
      if (window.pause) {
        return;
      }
      nes.f = nes.f || 0
      nes.f++;
      f.value = nes.f;
      nes.frame();
    }
    /**
     * TODO::
     *   音频无法播放 The AudioContext was not allowed to start（手机端加载存档后 直接也没声音）
     *   更流畅的双屏联机功能
     *   代码简化
     *   游戏选择功能
     *   重启游戏功能
     *   回放功能
     *   后台存储存档/存储nes文件
     */
    // 是否记录操作，不是 就自动按按钮
    // var romurl = "https://bmob-cdn-22939.bmobcloud.com/2019/06/23/7184934a405e956a804a676bc29c15ba.nes";
    if (localStorage.romurl == 'undefined') {
      localStorage.clear()
    }
    var romurl = localStorage.romurl ? localStorage.romurl :
      "./rom/Chip To Dale No Daisakusen 2 (J).nes"; //"./rom/mario.nes";
    localStorage.romurl = romurl;
    let isIn = true;
    let steps = {};
    if (!isIn) {
      steps = JSON.parse(localStorage.steps);
    }
    // 是否是存入档案阶段，不是 就自动读档
    let isNesIn = false;
    window.nes = null;
    var nes2 = null;
    // if (!isNesIn) {
    //   localStorage.nes ? (nes2 = JSON.parse(localStorage.nes)) : '';
    // }
    // 加载速度
    let frameSpeed = 1;
    let isConfigShow = false;
    var interval;
    let rDic = {}

    function setB2A(a, b, _k = []) {
      for (const key in b) {
        if (b.hasOwnProperty(key)) {
          const bV = b[key];
          if (bV instanceof Object) {
            if (a[key]) {
              // 透明度好了 step1 加上了这个好了
              // if (key == 'opaque') {
              //   return;
              //   console.log('keykeykeyk', opaque)
              // }
              setB2A(a[key], b[key], [..._k, key]);
            } else {
              // a[key] = {};
              // 这个地方很神奇，如果转换了 就报错了Cannot read property 'opaque' of undefined，但能显示主角，不显示背景
              // 如果把这里注释掉，就能显示背景，但主角和怪物什么的 都会变成马赛克
              a[key] = {}; // 透明度好了 step2 加上了这个好了
              setB2A(a[key], b[key], [..._k, key]);
              // console.log('key', key, bV)
            }
          } else {
            if (a[key] !== b[key] && _k && !rDic[_k]) {
              console.log(', _k', _k)
              rDic[_k.toString()] = 1
            }
            // if (_k[1] == 'mem' || _k[0] == 'mmap'
            //     // || _k[1] == 'vramMem' || _k[1] == 'spriteMem' || _k[1] == 'imgPalette' || _k[1] == 'buffer' || _k[1] == 'pixrendered' || _k[1] == 'bgbuffer'
            //     || _k[1] == 'nameTable'
            //     ) {
            //   a[key] = b[key];
            // }
            a[key] = b[key];
          }
        }
      }
    }

    function loadCpuMem(nes, mem) {
      nes.cpu.mem = mem;
    }

    function loadPpuNameTable(nes, nameTable) {
      setB2A(nes.ppu.nameTable, nameTable)
    }

    function loadMmap(nes, mmap) {
      setB2A(nes.mmap, mmap)
    }

    function loadSavedData() {
      console.log('load dataaaaaaaaaaaaa in')
      key = localStorage.romurl;
      if (localStorage[key]) {
        console.log('inininin')
        console.log('load dataaaaaaaaaaaaa innnnnnnnnnnnnnnn')
        nes2 = JSON.parse(localStorage[key]);
        // localStorage.nes ? (nes2 = JSON.parse(localStorage.nes)) : '';
        setB2A(nes, nes2);
        // nesSav = JSON.parse(localStorage[`${key}`]);
        // loadCpuMem(nes, nesSav.mem)
        // loadPpuNameTable(nes, nesSav.nameTable)
        // loadMmap(nes, nesSav.mmap)
      }
    }

    function saveData() {
      key = localStorage.romurl;
      localStorage.clear()
      // localStorage.nes = JSON.stringify(nes);
      localStorage[key] = JSON.stringify(nes);
      // localStorage[`${key}-mem`] = JSON.stringify(nes.cpu.mem);
      // localStorage[`${key}-bgbuffer`] = JSON.stringify(nes.ppu.bgbuffer);
      // localStorage[key] = JSON.stringify({
      //   mem: nes.cpu.mem,
      //   nameTable: nes.ppu.nameTable,
      //   mmap: nes.mmap
      // })
      localStorage.romurl = key;
    }
    $(function () {
      console.log($(document).width()); //浏览器时下窗口文档对于象宽度
      console.log($(document).height()); //浏览器时下窗口文档对于象宽度

      function RingBuffer(capacity, evictedCb) {
        this._elements = new Array(capacity || 50);
        this._first = 0;
        this._last = 0;
        this._size = 0;
        this._evictedCb = evictedCb;
      }
      RingBuffer.prototype.capacity = function () {
        return this._elements.length;
      };
      RingBuffer.prototype.isEmpty = function () {
        return this.size() === 0;
      };
      RingBuffer.prototype.isFull = function () {
        return this.size() === this.capacity();
      };
      RingBuffer.prototype.peek = function () {
        if (this.isEmpty()) throw new Error('RingBuffer is empty');
        return this._elements[this._first];
      };
      RingBuffer.prototype.peekN = function (count) {
        if (count > this._size) throw new Error('Not enough elements in RingBuffer');
        var end = Math.min(this._first + count, this.capacity());
        var firstHalf = this._elements.slice(this._first, end);
        if (end < this.capacity()) {
          return firstHalf;
        }
        var secondHalf = this._elements.slice(0, count - firstHalf.length);
        return firstHalf.concat(secondHalf);
      };
      RingBuffer.prototype.deq = function () {
        var element = this.peek();

        this._size--;
        this._first = (this._first + 1) % this.capacity();

        return element;
      };
      RingBuffer.prototype.deqN = function (count) {
        var elements = this.peekN(count);

        this._size -= count;
        this._first = (this._first + count) % this.capacity();

        return elements;
      };

      RingBuffer.prototype.enq = function (element) {
        this._end = (this._first + this.size()) % this.capacity();
        var full = this.isFull()
        if (full && this._evictedCb) {
          this._evictedCb(this._elements[this._end]);
        }
        this._elements[this._end] = element;

        if (full) {
          this._first = (this._first + 1) % this.capacity();
        } else {
          this._size++;
        }

        return this.size();
      };

      RingBuffer.prototype.size = function () {
        return this._size;
      };

      function Speakers(onBufferUnderrun) {
        this.onBufferUnderrun = onBufferUnderrun;
        this.bufferSize = 8192;
        this.buffer = new RingBuffer(this.bufferSize * 2);
      }
      Speakers.prototype.handleError = function (error, errorInfo) {
        console.error(error);
        // Raven.captureException(error, { extra: errorInfo });
      }
      Speakers.prototype.getSampleRate = function () {
        if (!window.AudioContext) {
          return 44100;
        }
        let myCtx = new window.AudioContext();
        let sampleRate = myCtx.sampleRate;
        myCtx.close();
        return sampleRate;
      }
      Speakers.prototype.start = function () {
        // Audio is not supported
        if (!window.AudioContext && !window.webkitAudioContext) {
          return;
        }
        if (!this.audioCtx) {
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
          this.audioCtx = new window.AudioContext();
          this.scriptNode = this.audioCtx.createScriptProcessor(1024, 0, 2);
          this.scriptNode.onaudioprocess = this.onaudioprocess.bind(this);
          this.scriptNode.connect(this.audioCtx.destination);
        }
      }
      Speakers.prototype.stop = function () {
        if (this.scriptNode) {
          this.scriptNode.disconnect(this.audioCtx.destination);
          this.scriptNode.onaudioprocess = null;
          this.scriptNode = null;
        }
        if (this.audioCtx) {
          this.audioCtx.close().catch(handleError);
          this.audioCtx = null;
        }
      }
      Speakers.prototype.writeSample = function (left, right) {
        if (this.buffer.size() / 2 >= this.bufferSize) {
          // console.log(`Buffer overrun`);
          this.buffer.deqN(this.bufferSize / 2);
        }
        this.buffer.enq(left);
        this.buffer.enq(right);
      };
      Speakers.prototype.onaudioprocess = function (e) {
        var left = e.outputBuffer.getChannelData(0);
        var right = e.outputBuffer.getChannelData(1);
        var size = left.length;
        // We're going to buffer underrun. Attempt to fill the buffer.
        if (this.buffer.size() < size * 2 && this.onBufferUnderrun) {
          this.onBufferUnderrun(this.buffer.size(), size * 2);
        }
        try {
          var samples = this.buffer.deqN(size * 2);
        } catch (e) {
          // onBufferUnderrun failed to fill the buffer, so handle a real buffer
          // underrun
          // ignore empty buffers... assume audio has just stopped
          var bufferSize = this.buffer.size() / 2;
          if (bufferSize > 0) {
            // console.log(`Buffer underrun (needed ${size}, got ${bufferSize})`);
          }
          for (var j = 0; j < size; j++) {
            left[j] = 0;
            right[j] = 0;
          }
          return;
        }
        for (var i = 0; i < size; i++) {
          left[i] = samples[i * 2];
          right[i] = samples[i * 2 + 1];
        }
      };
      // var url = "ws://" + window.location.host + "/ws";
      // var ws = new WebSocket(url);

      // var screen = $("<canvas width='256' height='240'>");
      var screen = $("#canvas");
      // screen[0].style.height ="500px";
      screen[0].style.height = window.innerWidth + "px";
      var m = (window.innerWidth / 240 * 256 - window.innerWidth) / 2;
      var n = (window.innerHeight / 240 * 256 - window.innerHeight) / 2;
      // screen[0].style.transform="translate(-50%, -50%)";
      screen[0].style.transform = "rotate(90deg) translate(0px," + m + "px)";
      screen[0].style.left = 0;
      screen[0].style.right = 0;
      screen[0].style.top = 0;
      screen[0].style.bottom = 0;
      screen[0].style.margin = "auto auto";
      window.context = screen[0].getContext('2d');
      var imageData = context.getImageData(0, 0, 256, 240);
      // $("#emulator").append(screen);
      this.player = 0;
      window.frame = 0;
      var prevBuffer = new Array(256 * 240);

      window.lastIsChangenge = '';

      function setTime() {
        if (window.lastIsChangenge != window.isChallenge) {
          window.lastIsChangenge = window.isChallenge;
          window.timeDom = window.timeDom || document.getElementById('time');
          if (window.isChallenge) {
            window.timeDom.style.display = 'inline-block';
          } else {
            window.timeDom.style.display = 'none';
          }
        }
        if (!window.isChallenge) {
          return;
        } else {
          window.timeDom = window.timeDom || document.getElementById('time');
          window.timeDom.style.display = 'inline-block';
        }
        if (!startFrame) {
          return;
        }
        // time.innerText = (Date.now() - sTs) - (frame * 16);
        let sms = (frame - startFrame) * 16;
        let ms = ('000' + sms % 1000).substr(-3);
        let ss = Math.floor(sms / 1000);
        let s = ('00' + ss % 60).substr(-2);
        let m = Math.floor(ss / 60);
        // time.innerText = (Date.now() - sTs) - (frame * 16); // 恒定在 63~68 之间，说明时间还算准确
        let usedTime = `${m}:${s}.${ms}`
        time.innerText = usedTime;
        return usedTime;
      }

      let isOk = false;
      let isCatch = false;
      window.isDie = false;
      window.isInDieCheck = false;

      function clearScreen() {
        context.fillStyle = "black";
        context.fillRect(0, 0, 256, 240);
        for (var i = 3; i < imageData.data.length - 3; i += 4) {
          imageData.data[i] = 0xFF;
        }
      }
      var speakers = new Speakers(
        function (actualSize, desiredSize) {
          if (this.props && this.props.paused) {
            return;
          }
        }
      );
      speakers.start()
      let lastTs = new Date().getTime();
      let sendDic = {};

      function createNes() {
        frame = 0;
        let sTs = Date.now();
        console.log('nes', nes)
        nes = new jsnes.NES({
          onFrame: function (buffer) {
            var data = imageData.data;
            var pixel, i, j;
            let c = 0;
            let transDic = {};
            if (frame > 0) {
              for (i = 0; i < 256 * 240; i++) {
                pixel = buffer[i];
                if (pixel != prevBuffer[i]) {
                  j = i * 4;
                  data[j] = pixel & 0xFF;
                  data[j + 1] = (pixel >> 8) & 0xFF;
                  data[j + 2] = (pixel >> 16) & 0xFF;
                  prevBuffer[i] = pixel;
                  c++
                  transDic[i] = pixel;
                }
              }
              // console.log(c)
              // console.log('transDic', JSON.stringify(transDic).length);
              let len = Object.keys(transDic).length;
              if (len) {
                let ts = new Date().getTime();
                if (ts - lastTs > 200) {
                  // for (i = 0; i < 256 * 240; i++) {
                  //   pixel = buffer[i];
                  //   if (pixel != sendDic[i]) {
                  //     sendDic[i] = pixel;
                  //   }
                  // }
                  lastTs = ts;
                }
              }
              context.putImageData(imageData, 0, 0);
              if (window.isChallenge) {
                if (!isOk) {
                  if (!isDie) {
                    if (startFrame && (frame - startFrame) > 4*60) {
                      let leftTopBlack = context.getImageData(10, 10, 1, 1).data;
                      let rightTopBlack = context.getImageData(245, 10, 1, 1).data;
                      if (leftTopBlack[0] == 0 && leftTopBlack[1] == 0 && leftTopBlack[2] == 0
                          && rightTopBlack[0] == 0 && rightTopBlack[1] == 0 && rightTopBlack[2] == 0) {
                        let marioHat = context.getImageData(105, 105, 1, 1).data;
                        if (marioHat[0] == 188 && marioHat[1] == 25 && marioHat[2] == 0) {
                          isDie = true;
                          alert('You are die, try again latter.')
                          window.location.reload();
                          return;
                        }
                      }
                    }
                  } else {
                    return;
                  }
                  if (!isCatch) {
                    for (let i = 0; i < 10; i++) {
                      let a = context.getImageData(200 + i, 72, 1, 1).data;
                      if (a[0] == 117 && a[1] == 227) {
                        isCatch = true;
                        console.log('okok')
                        console.log('a', a);
                      }
                    }
                  }
                  if (isCatch) {
                    let lastR;
                    for (let i = 0; i < 200; i++) {
                      let r = context.getImageData(40 + i, 186, 1, 1).data[0];
                      if (r == 117 && lastR == 255) {
                        if (!isOk) {
                          isOk = true;
                          let time = setTime();
                          if (window.isZZDJS) {
                            alert('The vedio is end');
                            delete window.isZZDJS;
                            window.arr = {};
                            isCatch = false;
                            isOk = false;
                            window.location.reload();
                          } else {
                            let xhr = new XMLHttpRequest();
                            xhr.open('POST', '/market/fc/setWin');
                            xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
                            xhr.onreadystatechange = function (ev) {
                              if (xhr.readyState == 4) {
                                console.log(ev.target.response)
                              }
                            }
                            xhr.send(JSON.stringify({
                              "userid": 1,
                              "step": localStorage.arr,
                              "usetime": (Number(time.split(':')[0]) * 60 + Number(time.split(':')[
                                1])) * 1000
                            }))
                            isCatch = false;
                            isOk = false;
                            alert('Congratulations, you used time: ' + time);
                            window.location.reload();
                          }
                        }
                      }
                      lastR = r;
                    }
                  }
                }
              }
              // ctx.strokeRect(200, 72, 12, 16);
              // goPikachu()
            }
            // 重要！！！按钮回放功能
            // if (steps[frame]) {
            //   for (let i = 0; i < steps[frame].length; i++) {
            //     let dic = steps[frame][i];
            //     let key = KEYS[dic.keyCode];
            //     if(dic.type == 'up') {
            //       nes.buttonUp(key[0], key[1]);
            //     } else if (dic.type == 'down') {
            //       console.log(frame, dic.type, dic, key)
            //       nes.buttonDown(key[0], key[1]);
            //     }
            //   }
            // }
            frame += 1;
            setTime();
            let _arr = arr[frame] || [];
            for (let i = 0; i < _arr.length; i++) {
              const tar = _arr[i];
              if (tar[2] == 'u') {
                nes.buttonUp(tar[0], tar[1], true, {
                  isVedio: true
                })
              } else if (tar[2] == 'd') {
                nes.buttonDown(tar[0], tar[1], true, {
                  isVedio: true
                })
              }
            }
            // if (frame < 2500) {
            //   console.log(frame);
            //   nes.frame()
            // }
            // send at 30 fps
            // if (frame === 2) {
            //   // sendScreen();
            //   // drawData(data);
            //   frame = 0;
            // }
            // 测试自动存储
            // if (frame > 500 && frame % 100 == 0 && isNesIn) {
            //   console.log('save frame', nes);
            //   localStorage.nes = JSON.stringify(nes);
            // }
          },
          onAudioSample: (...arg) => {
            // console.log(arg);
            speakers.writeSample.bind(speakers)(...arg)
          },
          sampleRate: speakers.getSampleRate()
        });

        let srcButtonUp = nes.buttonUp;
        let srcButtonDown = nes.buttonDown;

        window.arr = {};
        // if (localStorage.arr) {
        //   window.arr = JSON.parse(localStorage.arr);
        // }
        nes.buttonUp = (k0, k1, isNoEmit, config = {}) => {
          if (window.isZZDJS && !config.isVedio) {
            // 演示他人视频时，不能操控
            return;
          }
          if (!config.isVedio) {
            arr[frame] = arr[frame] || [];
            arr[frame].push([k0, k1, 'u']);
            localStorage.arr = JSON.stringify(arr);
          }
          document.getElementById(keyDomDic[k1]).classList.remove('active')
          let id = Math.random().toString().substr(2, 3);
          let fpsDic = window.fpsDic || {}
          fpsDic[id] = Date.now()
          let m_p = window.playerId;
          let m_f = nes.f;
          let m_b = !isNoEmit && socket.emit("m", {
            key: [k0, k1],
            type: "up",
            ts: Date.now(),
            id,
            cId: window.cId,
            f: nes.f,
            m: ""
          });
          window.fpsDic = fpsDic;
          srcButtonUp(k0, k1);
        }
        nes.buttonDown = (k0, k1, isNoEmit, config = {}) => {
          console.log(k0, k1)
          if (window.isZZDJS && !config.isVedio) {
            // 演示他人视频时，不能操控
            return;
          }
          if (!config.isVedio) {
            arr[frame] = arr[frame] || [];
            arr[frame].push([k0, k1, 'd']);
            localStorage.arr = JSON.stringify(arr);
          }
          if (!startFrame && keyDomDic[k1] == 'btnstart') {
            startFrame = frame;
          }
          document.getElementById(keyDomDic[k1]).classList.add('active')
          let id = Math.random().toString().substr(2, 3);
          let fpsDic = window.fpsDic || {}
          fpsDic[id] = Date.now();
          !isNoEmit && socket.emit('m', {
            key: [k0, k1],
            type: 'down',
            ts: Date.now(),
            cId: window.cId,
            id,
            f: nes.f
          })
          window.fpsDic = fpsDic;
          srcButtonDown(k0, k1)
        }
      }

      function loadGames() {
        // $.getJSON('/gamelist', function (data) {
        var data = {
          games: ['lj65.nes']
        }
        var html = '';
        var len = data.games.length;
        for (var i = 0; i < len; i++) {
          html += '<option value="' + data.games[i] + '">' + data.games[i].replace(".nes", "") + '</option>';
        }
        $('#current-game').append(html);
        // });
      }

      function loadROM(url) {
        $.ajax({
          url: escape(url),
          xhr: function () {
            var xhr = $.ajaxSettings.xhr();
            xhr.overrideMimeType('text/plain; charset=x-user-defined');
            return xhr;
          },
          complete: function (xhr, status) {
            nes.loadROM(xhr.responseText);
            nes.start();
          }
        });
      }

      function triggerKey(type, keyCode) {
        var e = jQuery.Event(type);
        e.which = keyCode;
        e.keyCode = keyCode;
        $(document).trigger(e);
      }

      function sendKey(type, keyCode) {
        ws.send(type + " " + keyCode);
      }

      function sendScreen(buffer) {
        var image = screen[0].toDataURL();
        ws.send("data " + image);
      }

      function drawData(data) {
        var img = new Image();
        img.src = data;
        context.drawImage(img, 0, 0);
      }

      function startPlaying(data) {
        window.player = parseInt(data, 10);
        if (window.player == 1) {
          newGame();
          $("#games-list").show();
          $("#message").text("You are Player 1");
        }
        if (window.player == 2) {
          $("#games-list").hide();
          $("#message").text("You are Player 2");
        }
      }

      function newGame() {
        var rom = document.getElementById("current-game").value;
        if (window.player == 1 && rom != "") {
          clearScreen();
          createNes();
          loadROM("/games?name=" + rom);
        }
      }
      window.newGame = newGame;

      function stopPlaying() {
        if (nes !== null) {
          nes.stop();
          nes = null;
        }
        clearScreen();
        window.player = 0;
        $("#message").text("Waiting for Player 2");
      }
      // ws.onmessage = function (msg) {
      //   var parts = msg.data.split(" ");
      //   var cmd = parts[0];
      //   var data = parts[1];

      //   if (cmd === "join") {
      //     startPlaying(data);
      //   }

      //   if (cmd === "part") {
      //     stopPlaying();
      //   }

      //   if (cmd === "keyup" || cmd === "keydown") {
      //     triggerKey(cmd, parseInt(data, 10));
      //   }

      //   if (cmd === "data") {
      //     drawData(data);
      //   }
      // };
      var keyMap = {
        88: 103,
        90: 105,
        17: 99,
        13: 97,
        38: 104,
        40: 98,
        37: 100,
        39: 102
      };

      const KEYS = {
        88: [1, jsnes.Controller.BUTTON_A, "X"], // X
        89: [1, jsnes.Controller.BUTTON_B, "Y"], // Y (Central European keyboard)
        90: [1, jsnes.Controller.BUTTON_B, "Z"], // Z
        17: [1, jsnes.Controller.BUTTON_SELECT, "Right Ctrl"], // Right Ctrl
        13: [1, jsnes.Controller.BUTTON_START, "Enter"], // Enter
        38: [1, jsnes.Controller.BUTTON_UP, "Up"], // Up
        40: [1, jsnes.Controller.BUTTON_DOWN, "Down"], // Down
        37: [1, jsnes.Controller.BUTTON_LEFT, "Left"], // Left
        39: [1, jsnes.Controller.BUTTON_RIGHT, "Right"], // Right

        103: [2, jsnes.Controller.BUTTON_A, "Num-7"], // Num-7
        105: [2, jsnes.Controller.BUTTON_B, "Num-9"], // Num-9
        99: [2, jsnes.Controller.BUTTON_SELECT, "Num-3"], // Num-3
        97: [2, jsnes.Controller.BUTTON_START, "Num-1"], // Num-1
        104: [2, jsnes.Controller.BUTTON_UP, "Num-8"], // Num-8
        98: [2, jsnes.Controller.BUTTON_DOWN, "Num-2"], // Num-2
        100: [2, jsnes.Controller.BUTTON_LEFT, "Num-4"], // Num-4
        102: [2, jsnes.Controller.BUTTON_RIGHT, "Num-6"] // Num-6
      };
      const keyDomDic = {
        0: 'btna',
        1: 'btnb',
        2: 'btnselect',
        3: 'btnstart',
        4: 'btnup',
        5: 'btndown',
        6: 'btnleft',
        7: 'btnright'
      }
      $(document).bind("contextmenu", function (evt) {
        evt.preventDefault();
      })
      // localStorage.step = '';

      $(document).bind("keydown", function (evt) {

        var key = KEYS[evt.keyCode];
        if (key) {
          nes.buttonDown(key[0], key[1]);
          console.log(key);
          steps[frame] = steps[frame] || [];
          steps[frame].push({
            type: "down",
            keyCode: evt.keyCode,
            frame
          })
          if (isIn) localStorage.steps = JSON.stringify(steps);
        }
        // nes.buttonDown(1, jsnes.Controller.BUTTON_A);
        // nes.keyboard.keyDown(evt);
        // if (window.player == 1) { nes.keyboard.keyDown(evt); }
        // if (window.player == 2 && keyMap[code]) { evt.preventDefault(); sendKey("keydown", keyMap[code]); }
      });

      $(document).bind("keyup", function (evt) {
        var key = KEYS[evt.keyCode];
        if (key) {
          nes.buttonUp(key[0], key[1]);
          steps[frame] = steps[frame] || [];
          steps[frame].push({
            type: "up",
            keyCode: evt.keyCode,
            frame
          })
          if (isIn) localStorage.steps = JSON.stringify(steps);
        }
        // if (window.player == 1) { nes.keyboard.keyUp(evt); }
        // if (window.player == 2 && keyMap[code]) { evt.preventDefault(); sendKey("keyup", keyMap[code]); }
      });
      // $('#btnall').bind("touchstart mousedown", function (evt) {
      //   console.log('touchstart');
      //   console.log(evt);
      //   // evt.preventDefault();
      //   // nes.buttonDown(KEYS[38][0], KEYS[38][1]);

      // });
      // $('#btnall').bind("touchmove mousemove", function (evt) {
      //   // console.log('touch');
      //   // console.log(evt);
      //   // evt.preventDefault();
      //   // nes.buttonDown(KEYS[38][0], KEYS[38][1]);

      // });
      // $('#btnall').bind("touchend mouseup", function (evt) {
      //   console.log('touchend');
      //   console.log(evt);
      //   // evt.preventDefault();
      //   // nes.buttonDown(KEYS[38][0], KEYS[38][1]);

      // });
      // 直接添加监听事件
      $(document).on('touchstart', function (e) {
        let touches = e.originalEvent.touches;
        touchBtn(touches);
      })
      $(document).on('touchend', function (e) {
        let touches = e.originalEvent.touches;
        // console.log('touchend', touches, e)
        touchBtn(touches, 'touchend');
      })

      $(document).on('touchmove', function (e) {
        let touches = e.originalEvent.touches;
        // console.log('touchmove', touches, e)
        touchBtn(touches);
      })

      var touchDic = {
        'btnup': 0,
        'btnright': 0,
        'btn12': 0,
        'btn14': 0,
        'btndown': 0,
        'btnleft': 0,
        'btn23': 0,
        'btn34': 0,
        'btna': 0,
        'btnb': 0
      }

      function touchBtn(touches, type) {
        console.log(type)
        // ['btnup', 'btnright', 'btn12', 'btn14', 'btndown', 'btnleft', 'btn23', 'btn34', 'btna', 'btnb']
        for (let i = 0; i < touches.length; i++) {
          const tarTouch = touches[i];
          let x = tarTouch.clientX;
          let y = tarTouch.clientY;
          let dom = document.elementFromPoint(x, y);
          if (touchDic[dom.id] === 0) {
            touchDic[dom.id] = 3; // 待处理
          }
          if (touchDic[dom.id] === 1) {
            touchDic[dom.id] = 2; // 已处理
          }
        }
        for (const i in touchDic) {
          if (type) {
            console.log(i, touchDic[i])
          }
          if (touchDic.hasOwnProperty(i)) {
            const tarTouch = touchDic[i];
            if (touchDic[i] === 1) {
              touchDic[i] = 0;
              // document.getElementById(i).classList.remove('active') // 已改到函数里面加状态
              processBtn({
                id: i
              }, 0) // 抬起
            }
            if (touchDic[i] === 2) {
              touchDic[i] = 1;
            }
          }
        }
        for (const i in touchDic) {
          if (touchDic[i] === 3) {
            // document.getElementById(i).classList.add('active') // 已改到函数里面加状态
            processBtn({
              id: i
            }, 1) // 按下
            touchDic[i] = 1; // 已按下
          }
        }
        console.log(touchDic);
      }
      let playerId = window.playerId;

      function processBtn(dom, isDown, playerId) {
        playerId = playerId || window.playerId;
        console.log(arguments);
        let tarFunc;
        if (isDown) {
          tarFunc = nes.buttonDown;
        } else {
          tarFunc = nes.buttonUp;
        }

        if (dom.id == 'btnup') {
          tarFunc(playerId, KEYS[38][1]);
        }
        if (dom.id == 'btnright') {
          tarFunc(playerId, KEYS[39][1]);
        }
        if (dom.id == 'btn12') {
          tarFunc(playerId, KEYS[38][1]);
          tarFunc(playerId, KEYS[39][1]);
        }
        if (dom.id == 'btn14') {
          tarFunc(playerId, KEYS[38][1]);
          tarFunc(playerId, KEYS[37][1]);
        }
        if (dom.id == 'btndown') {
          tarFunc(playerId, KEYS[40][1]);
        }
        if (dom.id == 'btnleft') {
          tarFunc(playerId, KEYS[37][1]);
        }
        if (dom.id == 'btn23') {
          tarFunc(playerId, KEYS[39][1]);
          tarFunc(playerId, KEYS[40][1]);
        }
        if (dom.id == 'btn34') {
          tarFunc(playerId, KEYS[40][1]);
          tarFunc(playerId, KEYS[37][1]);
        }
        if (dom.id == 'btna') {
          tarFunc(playerId, KEYS[88][1]);
        }
        if (dom.id == 'btnb') {
          tarFunc(playerId, KEYS[89][1]);
        }
      }
      $('#changePlayer').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        if (window.playerId == 2) {
          window.playerId = 1;
          $('#changePlayer').css('background-image', "url('./img/player1.png')");
        } else {
          window.playerId = 2;
          $('#changePlayer').css('background-image', "url('./img/player2.png')");
        }
        if (window.playerId == 2) {
          document.getElementById('canvas').style.display = 'none';
          document.getElementById('canvasTips').innerHTML = '<span>请看P1的屏幕</span>';
        } else {
          document.getElementById('canvasTips').innerText = ''
          document.getElementById('canvas').style.display = 'block';
        }
      });
      $('#changePlayer').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });

      $('#btnsave').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        saveData()
      });
      $('#btnsave').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });
      $('#btnload').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        loadSavedData();
      });
      $('#btnload').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });
      $('#btnspeed').bind("touchstart mousedown", function (evt) {
        if (frameSpeed == 1) frameSpeed = 5;
        else frameSpeed = 1;
        evt.preventDefault();
        // clearInterval(autoSaveInter)
        localStorage.clear()
      });
      $('#btnspeed').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
      });

      $('#btnselect').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        nes.buttonDown(KEYS[17][0], KEYS[17][1]);
        socket.emit("message", {
          type: "down",
          key: [KEYS[17][0], KEYS[17][1]]
        })
        if (speakers.audioCtx)
          speakers.audioCtx.resume();
      });
      $('#btnselect').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
        nes.buttonUp(KEYS[17][0], KEYS[17][1]);
        socket.emit("message", {
          type: "up",
          key: [KEYS[17][0], KEYS[17][1]]
        })
      });
      $('#btnstart').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        nes.buttonDown(KEYS[13][0], KEYS[13][1]);
        socket.emit("message", {
          type: "down",
          key: [KEYS[13][0], KEYS[13][1]]
        })
        if (speakers.audioCtx)
          speakers.audioCtx.resume();
      });
      $('#btnstart').bind("touchend mouseup", function (evt) {
        evt.preventDefault();
        nes.buttonUp(KEYS[13][0], KEYS[13][1]);
        socket.emit("message", {
          type: "up",
          key: [KEYS[13][0], KEYS[13][1]]
        })
      });
      $('#config-btn').bind("touchstart mousedown", function (evt) {
        evt.preventDefault();
        isConfigShow = !isConfigShow;
        if (isConfigShow) {
          $('#game-list-box').show();
          $('#btnsave').hide();
          $('#btnload').show();
        } else {
          $('#game-list-box').hide();
          $('#btnsave').show();
          $('#btnload').hide();
        }
      });

      clearScreen();
      createNes();

      function loadBinary(path, callback, handleProgress) {
        var req = new XMLHttpRequest();
        req.open("GET", path);
        req.overrideMimeType("text/plain; charset=x-user-defined");
        req.onload = function () {
          if (this.status === 200) {
            if (req.responseText.match(/^<!doctype html>/i)) {
              // Got HTML back, so it is probably falling back to index.html due to 404
              return callback(new Error("Page not found"));
            }

            callback(null, this.responseText);
          } else if (this.status === 0) {
            // Aborted, so ignore error
          } else {
            callback(new Error(req.statusText));
          }
        };
        req.onerror = function () {
          callback(new Error(req.statusText));
        };
        req.onprogress = handleProgress;
        req.send();
        return req;
      }

      loadBinary(romurl, (err, data) => {
        if (err) {
          // this.setState({ error: `Error loading ROM: ${err.message}` });
          console.log(err);
        } else {
          nes.loadROM(data);
          // loadSavedData() // 自动读取有莫名奇妙的问题
          // autoSaveInter = setInterval(()=>{
          //   console.log('saveddddddddddddddddddddd')
          //   saveData()
          // }, 5000)
          window.nesInterval = setInterval(function () {
            goF(nes);
            if (frameSpeed == 5) {
              goF(nes);
              goF(nes);
            }
          }, 16);
          // 重要！！！ 这里可以证明 只要把整个 nes存下来 就可以 做到存档
          // setTimeout(()=>{
          //   nes2 = nes;
          //   createNes();
          //   nes.loadROM(data);
          // }, 15000)
          // setTimeout(()=>{
          //   nes = nes2;
          // }, 20000)
          // console.log("nes2['cpu']['mem']", nes2['cpu']['mem'])
          // nes['cpu']['mem'] = nes2['cpu']['mem'];
          let c = 0;
          /// 哇塞塞！！！好像成功了耶
          // for (const key in nes2) {
          //   c++
          //   if (c==4) {
          //     console.log('key', key);
          //     const element = nes2[key];
          //     let d = 0;
          //     for (const key2 in element) {
          //       // if (element.hasOwnProperty(key2)) {
          //       //   const element2 = element[key2];
          //       //   nes[key] = nes[key] || nes2[key];
          //       //   nes[key][key2] = element2;
          //       // }
          //       console.log(key2);
          //     }
          //     continue;
          //   }
          //   if (nes2.hasOwnProperty(key) && c != 4) {
          //     console.log(key);
          //     const element = nes2[key];
          //     for (const key2 in element) {
          //       if (element.hasOwnProperty(key2)) {
          //         const element2 = element[key2];
          //         nes[key] = nes[key] || nes2[key];
          //         nes[key][key2] = element2;
          //       }
          //     }
          //   }
          // }
          // 不自动读档，在config里面，去点击读档
          // setB2A(nes, nes2);
          // this.handleLoaded(data);
        }
      }, null)

      window.onunload = function () {
        if (interval)
          clearInterval(interval);
        speakers.stop();
        console.log('onunload');
      };
    });

    function doSth(key) {

    }
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // 暂时关闭联机功能
    let socket = {
      emit: function emit(...args) {
        console.log('emit', args);
      },
    }
    // socket = io.connect('ws://192.168.1.47:3000');
    // socket = io.connect('ws://192.168.0.3:3000');
    socket = io.connect('//tekii.cn/');
    socket.emit("m", {
      "name": navigator.userAgent,
      "msg": "hello world"
    });
    // setInterval(()=>{
    //   nes2 = JSON.parse(localStorage['ljNes']);
    //   let f = nes.f
    //   nes2.f = JSON.parse(localStorage.f||'0')
    //   console.log('old', nes2.f)

    //   setB2A(nes, nes2);
    //   console.log('new', nes.f)
    //   console.log(nes.f, f)
    //   while(nes.f < f) {
    //     goF(nes)
    //     console.log('addd', nes.f)
    //   }
    //   localStorage['ljNes'] = JSON.stringify(nes);
    //   localStorage.f = nes.f;
    // }, 300)
    socket.on("m", function (obj) {
      // return;
      console.log(obj);
      let key = obj.key;
      let fpsDic = window.fpsDic || {}
      console.log('obj.id', obj.id, fpsDic[obj.id])
      let lTs = obj.ts //fpsDic[obj.id];
      let nTs = Date.now();
      console.log(nTs, lTs, nTs - lTs)
      fps.value = (nTs - lTs).toFixed(2) + 'ms';
      while (nes.f < obj.f) {
        goF(nes); // 追上队友的frameCount
      }
      if (obj.cId == window.cId) {
        return;
      }
      if (obj.type == 'up') {
        nes.buttonUp(key[0], key[1], true);
      } else if (obj.type == 'down') {
        nes.buttonDown(key[0], key[1], true);
      }
    });
    socket.on("u", function (obj) {
      console.log('u', obj);
    })
  </script>
</body>

</html>